{% extends "layout.html" %}

{% block content %}
<div class="container" x-data="templatesManager()">
    <header class="flex justify-between items-center mb-4">
        <div>
            <h2>Template Library</h2>
            <p class="color-muted">Manage reusable playbooks templates.</p>
        </div>
        <div class="flex items-center gap-2" style="display: flex; gap: 12px; align-items: center;">
            <div style="position: relative; height: 32px;">
                <i data-lucide="search"
                    style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; color: var(--ds-gray-600); pointer-events: none;"></i>
                <input type="text" x-model="searchQuery" placeholder="Search templates..."
                    style="padding-left: 32px; height: 32px; width: 220px; font-size: 13px; margin: 0; border-radius: 6px; box-shadow: none !important;">
            </div>
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="primary" @click="openNewTemplateModal()">
                <i data-lucide="plus" style="width: 14px; height: 14px;"></i> New Template
            </button>
            {% endif %}
        </div>
    </header>

    <div class="overflow-auto">
        <!-- Inject Role -->
        <script>
            window.currentUserRole = "{{ request.state.user.role if request.state.user else 'watcher' }}";
        </script>
        <table class="striped" style="width: 100%;">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Author</th>
                    <th style="text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="template in filteredTemplates" :key="template.id">
                    <tr class="hover">
                        <td>
                            <strong x-text="template.title"></strong>
                            <div style="color: #666; font-size: 13px; margin-top: 2px;" x-text="template.description">
                            </div>
                        </td>
                        <td>
                            <template x-if="template.category">
                                <span class="group-badge" x-text="template.category"></span>
                            </template>
                            <template x-if="!template.category">
                                <span style="color: var(--ds-gray-600); font-size: 12px;">Uncategorized</span>
                            </template>
                        </td>
                        <td>
                            <span class="color-muted" style="font-size: 13px;"
                                x-text="template.author || 'Unknown'"></span>
                        </td>
                        <td style="text-align: right;">
                            <div class="flex gap-2" x-show="window.currentUserRole === 'admin'"
                                style="display: flex; justify-content: flex-end; gap: 4px;">
                                <button class="btn-icon" @click="editTemplate(template)" title="Edit">
                                    <i data-lucide="edit-3" style="width: 14px; height: 14px;"></i>
                                </button>
                                <button class="btn-icon" style="color: var(--sible-error);"
                                    @click="deleteTemplate(template)" title="Delete">
                                    <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </template>
                <tr x-show="filteredTemplates.length === 0">
                    <td colspan="4" class="text-center p-5 color-muted">
                        No templates found. Create one to get started!
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

</div>

{% include "partials/template_editor_modal.html" %}

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('templatesManager', () => ({
            templates: [],
            searchQuery: '',

            get filteredTemplates() {
                if (!this.searchQuery) return this.templates;
                const q = this.searchQuery.toLowerCase();
                return this.templates.filter(t =>
                    (t.title && t.title.toLowerCase().includes(q)) ||
                    (t.description && t.description.toLowerCase().includes(q)) ||
                    (t.category && t.category.toLowerCase().includes(q))
                );
            },

            init() {
                this.fetchTemplates();
                // Listen for save events to refresh
                window.addEventListener('template-saved', () => this.fetchTemplates());

                // Re-initialize icons when filtering
                this.$watch('searchQuery', () => {
                    this.$nextTick(() => {
                        lucide.createIcons();
                    });
                });
            },

            async fetchTemplates() {
                try {
                    const res = await fetch('/api/templates');
                    if (res.ok) {
                        this.templates = await res.json();
                        this.$nextTick(() => {
                            lucide.createIcons();
                        });
                    }
                } catch (e) {
                    console.error("Failed to fetch templates", e);
                }
            },

            openNewTemplateModal() {
                window.dispatchEvent(new CustomEvent('open-template-editor', { detail: { mode: 'create' } }));
            },

            editTemplate(template) {
                window.dispatchEvent(new CustomEvent('open-template-editor', { detail: { mode: 'edit', template: template } }));
            },

            async deleteTemplate(template) {
                if (!confirm(`Delete template "${template.title}"?`)) return;

                try {
                    const res = await fetch(`/api/templates/${template.id}`, { method: 'DELETE' });
                    if (res.ok) {
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Template deleted', level: 'success' } }));
                        this.fetchTemplates();
                    } else {
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Failed to delete', level: 'error' } }));
                    }
                } catch (e) {
                    console.error(e);
                }
            }
        }));
    });
</script>
{% endblock %}