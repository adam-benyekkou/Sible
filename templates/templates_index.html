{% extends "layout.html" %}

{% block content %}
<div class="container" x-data="templatesManager()">
    <div style="margin-bottom: 24px;">
        <h2>Template Library</h2>
        <p class="color-muted">Manage reusable playbooks templates.</p>
    </div>

    <!-- Actions exactly above the table -->
    <div style="display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 4px; align-items: center;">
        <div style="position: relative; height: 32px;">
            <i data-lucide="search"
                style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; color: var(--text-muted); pointer-events: none;"></i>
            <input type="text" x-model="searchQuery" placeholder="Search templates..."
                style="padding-left: 32px; height: 32px; width: 220px; font-size: 13px; margin: 0; border-radius: 6px; box-shadow: none !important; background: var(--surface-secondary); border: 1px solid var(--border-subtle); color: var(--text-primary);">
        </div>

        {% if request.state.user and request.state.user.role == 'admin' %}
        <button class="primary" @click="openNewTemplateModal()"
            style="height: 32px; padding: 0 12px; font-size: 13px; display: inline-flex; align-items: center;">
            <i data-lucide="plus" style="width: 14px; height: 14px; margin-right: 6px;"></i> New Template
        </button>
        {% endif %}
    </div>

    <div class="overflow-auto">
        <!-- Inject Role -->
        <script>
            window.currentUserRole = "{{ request.state.user.role if request.state.user else 'watcher' }}";
        </script>
        <table class="striped" style="width: 100%;">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Category</th>
                    <th>Author</th>
                    <th
                        style="padding: 12px 16px; text-align: right; width: 1%; white-space: nowrap; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; color: var(--ds-gray-600); font-weight: 600;">
                        Actions</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="template in filteredTemplates" :key="template.id">
                    <tr class="hover">
                        <td>
                            <strong x-text="template.title"></strong>
                            <div style="color: var(--text-muted); font-size: 13px; margin-top: 2px;"
                                x-text="template.description">
                            </div>
                        </td>

                        <td>
                            <template x-if="template.category">
                                <span class="group-badge" x-text="template.category"></span>
                            </template>
                            <template x-if="!template.category">
                                <span style="color: var(--text-muted); font-size: 12px;">Uncategorized</span>
                            </template>

                        </td>
                        <td>
                            <span class="color-muted" style="font-size: 13px;"
                                x-text="template.author || 'Unknown'"></span>
                        </td>
                        <td style="padding: 12px 16px; text-align: right; width: 1%; white-space: nowrap;">
                            <div x-show="window.currentUserRole === 'admin'"
                                style="display: flex !important; flex-direction: row !important; justify-content: flex-end !important; gap: 8px !important; flex-wrap: nowrap !important; margin-right: -6px;">
                                <button class="action-btn" @click="editTemplate(template)" title="Edit">
                                    <i data-lucide="edit-3" style="width: 14px; height: 14px;"></i>
                                </button>
                                <button class="action-btn" style="color: var(--sible-error);"
                                    @click="deleteTemplate(template)" title="Delete">
                                    <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                                </button>
                            </div>
                        </td>

                    </tr>
                </template>
                <tr x-show="filteredTemplates.length === 0">
                    <td colspan="4" class="text-center p-5 color-muted">
                        No templates found. Create one to get started!
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="card"
        style="margin-top: 16px; padding: 12px; display: flex; justify-content: space-between; align-items: center;"
        x-show="pagination.totalPages > 1">
        <div style="font-size: 13px; color: var(--text-muted);">
            Page <span style="font-weight: 500; color: var(--text-primary);" x-text="pagination.page"></span> of <span
                x-text="pagination.totalPages"></span>
            <span style="color: var(--text-muted); margin-left: 8px;">(<span x-text="pagination.totalCount"></span>
                templates)</span>
        </div>

        <div style="display: flex; gap: 8px;">
            <button class="secondary" @click="fetchTemplates(pagination.page - 1)" :disabled="!pagination.hasPrev"
                style="height: 28px; padding: 0 12px; font-size: 12px; border-radius: 6px; border: 1px solid var(--border-subtle); background: var(--surface-primary); color: var(--text-primary); cursor: pointer; margin-bottom: 0;">Previous</button>
            <button class="secondary" @click="fetchTemplates(pagination.page + 1)" :disabled="!pagination.hasNext"
                style="height: 28px; padding: 0 12px; font-size: 12px; border-radius: 6px; border: 1px solid var(--border-subtle); background: var(--surface-primary); color: var(--text-primary); cursor: pointer; margin-bottom: 0;">Next</button>
        </div>

    </div>

</div>

{% include "partials/template_editor_modal.html" %}

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('templatesManager', () => ({
            templates: [],
            searchQuery: '',
            pagination: { page: 1, totalPages: 1, totalCount: 0, hasNext: false, hasPrev: false },

            get filteredTemplates() {
                if (!this.searchQuery) return this.templates;
                const q = this.searchQuery.toLowerCase();
                return this.templates.filter(t =>
                    (t.title && t.title.toLowerCase().includes(q)) ||
                    (t.description && t.description.toLowerCase().includes(q)) ||
                    (t.category && t.category.toLowerCase().includes(q))
                );
            },

            init() {
                this.fetchTemplates(1);
                window.addEventListener('template-saved', () => this.fetchTemplates(this.pagination.page));

                this.$watch('searchQuery', () => {
                    this.$nextTick(() => {
                        lucide.createIcons();
                    });
                });
            },

            async fetchTemplates(page = 1) {
                try {
                    const res = await fetch(`/api/templates?page=${page}`);
                    if (res.ok) {
                        const data = await res.json();
                        this.templates = data.templates;
                        this.pagination = {
                            page: data.page,
                            totalPages: data.total_pages,
                            totalCount: data.total_count,
                            hasNext: data.has_next,
                            hasPrev: data.has_prev
                        };
                        this.$nextTick(() => {
                            lucide.createIcons();
                        });
                    }
                } catch (e) {
                    console.error("Failed to fetch templates", e);
                }
            },

            openNewTemplateModal() {
                window.dispatchEvent(new CustomEvent('open-template-editor', { detail: { mode: 'create' } }));
            },

            editTemplate(template) {
                window.dispatchEvent(new CustomEvent('open-template-editor', { detail: { mode: 'edit', template: template } }));
            },

            async deleteTemplate(template) {
                if (!confirm(`Delete template "${template.title}"?`)) return;

                try {
                    const res = await fetch(`/api/templates/${template.id}`, { method: 'DELETE' });
                    if (res.ok) {
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Template deleted', level: 'success' } }));
                        this.fetchTemplates();
                    } else {
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Failed to delete', level: 'error' } }));
                    }
                } catch (e) {
                    console.error(e);
                }
            }
        }));
    });
</script>
{% endblock %}