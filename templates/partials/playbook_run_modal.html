<div class="modal-wrapper"
    style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.45); backdrop-filter: blur(4px); z-index: 2000; display: flex; justify-content: center; align-items: center;"
    x-data="{ 
        running: false,
        launchParams: {
            limit: ['all'],
            availableTargets: { hosts: [], groups: [], all: ['all'] },
            tags: '',
            verbosity: 0
        },
        async fetchTargets() {
            try {
                const res = await fetch('/api/inventory/targets');
                if (res.ok) this.launchParams.availableTargets = await res.json();
            } catch(e) { console.error(e); }
        },
        getExtraVarsJson() {
            let obj = {};
            const container = document.querySelector('#playbook-vars-container-standalone');
            if (container) {
                const dynInputs = container.querySelectorAll('input[name=extra_vars]');
                dynInputs.forEach(input => {
                    if (input.value) { try { Object.assign(obj, JSON.parse(input.value)); } catch(e) {} }
                });
            }
            return JSON.stringify(obj);
        }
    }" x-init="fetchTargets(); lucide.createIcons();" @keydown.escape.window="$root.remove()"
    @click.self="$root.remove()">

    <article :style="running ? 'max-width: 90vw; width: 1000px;' : 'max-width: 700px; min-width: 500px; width: 100%;'"
        style="border: 1px solid var(--border-subtle); box-shadow: 0 20px 40px rgba(0,0,0,0.15); background: var(--surface-primary); border-radius: 12px; overflow: hidden; animation: modalScaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); transition: all 0.3s ease; margin-bottom: 0 !important;">


        <header
            style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-subtle); padding: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div x-show="running" class="status-dot status-running" style="width: 10px; height: 10px;"></div>
                <h5 style="margin: 0; font-weight: 600; color: var(--text-primary);"
                    x-text="running ? 'Executing: {{ name }}' : 'Launch Playbook: {{ name }}'"></h5>
            </div>
            <button type="button" aria-label="Close" @click="$root.remove()" class="action-btn">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
            </button>

        </header>


        <section style="padding: 2rem;">
            <!-- Configuration Form -->
            <form x-show="!running" @submit.prevent=" 
                running = true;
                let vals={ 
                    limit: Array.isArray(launchParams.limit) ? launchParams.limit.join(',') : launchParams.limit, 
                    tags: launchParams.tags, 
                    verbosity: launchParams.verbosity, 
                    extra_vars: getExtraVarsJson() 
                }; 
                htmx.ajax('POST', '/run/{{ name | safe }}', { values: vals, target: '#modal-terminal-swap', swap: 'innerHTML' }); 
            ">
                <div style="margin-bottom: 1.5rem; position: relative;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px;">Target
                        Hosts / Groups</label>

                    <div x-data="{ initialTargets: launchParams.limit.join(',') }"
                        @targets-changed="launchParams.limit = $event.detail">
                        {% with picker_id='launch-target-picker-standalone' %}
                        {% include "partials/target_picker.html" %}
                        {% endwith %}
                    </div>
                </div>

                <div class="grid" style="gap: 24px; margin-bottom: 1.5rem;">
                    <label>
                        <span style="font-size: 13px; font-weight: 500; color: var(--text-muted);">Tags</span>
                        <input type="text" x-model="launchParams.tags" placeholder="e.g. deploy, !db"
                            style="font-size: 14px; margin-top: 4px; background: var(--surface-secondary); color: var(--text-primary); border: 1px solid var(--border-subtle);">
                    </label>
                    <label>
                        <span style="font-size: 13px; font-weight: 500; color: var(--text-muted);">Verbosity</span>
                        <select x-model="launchParams.verbosity"
                            style="height: 42px; font-size: 14px; margin-top: 4px; background: var(--surface-secondary); color: var(--text-primary); border: 1px solid var(--border-subtle);">

                            <option value="0">Normal</option>
                            <option value="1">Verbose (-v)</option>
                            <option value="2">More Verbose (-vv)</option>
                            <option value="3">Debug (-vvv)</option>
                        </select>
                    </label>
                </div>

                <div style="margin-top: 1rem;">
                    <strong
                        style="font-size: 13px; display: block; margin-bottom: 8px; color: var(--text-primary);">Variables</strong>
                    <div id="playbook-vars-container-standalone" hx-get="/api/playbook-vars/{{ name | safe }}"
                        hx-trigger="load" hx-swap="innerHTML">
                        <div style="padding: 10px 0; color: var(--text-muted); font-size: 0.9em;">
                            <span aria-busy="true" style="font-size: 0.9em;">Loading variables...</span>
                        </div>
                    </div>

                </div>

                <footer style="margin-top: 2rem; padding: 0; border-top: none;">
                    <button type="submit" class="primary" style="width: 100%; height: 42px;">
                        <i data-lucide="rocket" style="width: 16px; height: 16px;"></i>
                        Launch Playbook
                    </button>
                </footer>

            </form>

            <!-- Real-time Terminal Area -->
            <div x-show="running" x-cloak>
                <div id="modal-terminal-swap">
                    <!-- terminal_connect.html will be loaded here -->
                </div>
                <div class="terminal-pane"
                    style="margin-top: 1rem; border: 1px solid var(--border-subtle); border-radius: 8px; overflow: hidden;">
                    <div id="terminal-container"
                        style="background-color: var(--surface-secondary); color: var(--text-primary); font-family: 'Geist Mono', monospace; font-size: 13px; padding: 1.5rem; height: 400px; overflow-y: auto; white-space: pre-wrap;">
                        <div class="waiting-text" style="color: var(--text-muted);">Initializing execution...</div>
                    </div>
                </div>

            </div>
        </section>
    </article>
</div>