<div class="h-100 flex-col" x-data="{ isEditing: false, showScheduleModal: false, cronExpression: '0 3 * * *' }">
    <style>
        /* Fix Ace Editor Alignment */
        .ace_editor,
        .ace_editor * {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'Source Code Pro', monospace !important;
            font-size: 14px !important;
            line-height: 24px !important;
        }

        /* Ensure gutter is visible but keep original colors */
        .ace_gutter-cell {
            padding-left: 10px !important;
            padding-right: 10px !important;
            display: block !important;
            /* Restore block display for visibility */
        }

        .ace_scroller {
            line-height: 24px !important;
        }

        /* Hide fold widgets */
        .ace_fold-widget {
            display: none !important;
        }

        /* Padding for top text */
        .ace_gutter {
            padding-top: 12px !important;
        }

        .ace_scroller {
            top: 12px !important;
        }
    </style>

    <!-- Schedule Modal -->
    <dialog :open="showScheduleModal">
        <article>
            <header>
                <button aria-label="Close" rel="prev" @click="showScheduleModal = false"></button>
                <h5>Schedule {{ name }}</h5>
            </header>
            <p>
                Run this playbook automatically using a Cron expression.
            </p>
            <input type="text" x-model="cronExpression" placeholder="* * * * *">
            <small>Example: <code>0 3 * * *</code> (Every day at 3am)</small>
            <footer>
                <button class="secondary" @click="showScheduleModal = false">Cancel</button>
                <button @click="
                    htmx.ajax('POST', '/schedule', {
                        values: { playbook: '{{ name }}', cron: cronExpression },
                        swap: 'none'
                    });
                    showScheduleModal = false;
                ">
                    Save Schedule
                </button>
            </footer>
        </article>
    </dialog>
    <header class="main-header">
        <div class="header-left">
            <h4>{{ name }}</h4>
        </div>
        <div class="actions">
            <!-- Edit (Toggle) -->
            <button class="contrast" x-show="!isEditing" @click="isEditing = true; window.startEditing()">
                Edit
            </button>
            <button class="contrast" x-show="isEditing" @click="isEditing = false; window.discardEditing()">
                Discard
            </button>

            <!-- Check (Dry Run) -->
            <button class="contrast" hx-post="/check/{{ name | safe }}" hx-target="#terminal-container"
                hx-swap="innerHTML" title="Dry Run (Check Mode)">
                Check
            </button>

            <!-- Run -->
            <button class="primary" hx-post="/run/{{ name | safe }}" hx-target="#terminal-container"
                hx-swap="innerHTML">
                Run Playbook
            </button>

            <!-- Save -->
            <button class="contrast" @click="saveFile(); isEditing = false; window.setEditorReadOnly(true)">
                Save
            </button>

            <!-- Schedule (Modal Trigger) -->
            <button class="contrast" @click="showScheduleModal = true">
                Schedule
            </button>

            <!-- History -->
            <button class="contrast" hx-get="/history/{{ name | safe }}" hx-target="body" hx-swap="beforeend">
                History
            </button>

            <button class="contrast" hx-post="/playbook/{{ name | safe }}/install-requirements"
                hx-target="#terminal-container" hx-swap="innerHTML"
                title="Install Ansible Galaxy dependencies (requires requirements.yml)">
                Install Roles
            </button>

            <!-- Delete Button -->
            <button class="danger" hx-delete="/playbook/{{ name | safe }}"
                hx-confirm="Are you sure you want to delete {{ name }}? This cannot be undone."
                hx-target="#main-content">
                Delete
            </button>
        </div>
    </header>

    <div class="content-area">
        <!-- Editor Pane -->
        <div class="editor-pane">
            <div id="editor"></div>
        </div>

        <!-- Terminal Pane -->
        <div class="terminal-pane">
            <div id="terminal-container">
                <div class="waiting-text">Waiting for execution...</div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form for HTMX/JS to store state -->
<textarea id="hidden-content" class="d-none">{{ content }}</textarea>

<script>
    (function () {
        function initAce() {
            var editorDiv = document.getElementById("editor");
            if (!editorDiv) return;

            // Prevent double init
            if (editorDiv.classList.contains("ace_editor")) return;

            // Wait for x-show / DOM paint
            setTimeout(function () {
                var editor = ace.edit("editor");
                editor.setTheme("ace/theme/tomorrow_night_eighties");
                editor.session.setMode("ace/mode/yaml");

                // Default to Read Only
                editor.setReadOnly(true);

                // Internal state for undo
                var originalContent = "";

                // Global Helpers
                window.setEditorReadOnly = function (readonly) {
                    editor.setReadOnly(readonly);
                    if (!readonly) editor.focus();
                };

                window.startEditing = function () {
                    originalContent = editor.getValue();
                    editor.setReadOnly(false);
                    editor.focus();
                };

                window.discardEditing = function () {
                    editor.setValue(originalContent, -1);
                    editor.setReadOnly(true);
                };

                // Ensure text is visible
                editor.setShowPrintMargin(false);

                var contentArea = document.getElementById("hidden-content");
                if (contentArea) {
                    editor.setValue(contentArea.value, -1);
                }

                // Force resize
                editor.resize();

                // Save handler
                window.saveFile = function () {
                    var content = editor.getValue();
                    htmx.ajax('POST', '/playbook/{{ name }}', {
                        values: { content: content },
                        swap: 'none'
                    }).then(() => {
                        // Update original content to the new saved state
                        originalContent = content;
                    });
                };

                // Linting Logic
                function debounce(func, wait) {
                    let timeout;
                    return function (...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                }

                function lintCode() {
                    var content = editor.getValue();
                    // Use URLSearchParams for form data
                    var formData = new URLSearchParams();
                    formData.append('content', content);

                    fetch('/lint', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(annotations => {
                            editor.getSession().setAnnotations(annotations);
                        })
                        .catch(e => console.error("Lint error", e));
                }

                var debouncedLint = debounce(lintCode, 1000);

                editor.session.on('change', function () {
                    if (!editor.getReadOnly()) {
                        debouncedLint();
                    }
                });

                // Initial lint on edit start
                var _startEditing = window.startEditing;
                window.startEditing = function () {
                    _startEditing();
                    lintCode();
                };
            }, 100);
        }

        // Run Init
        initAce();
    })();
</script>