<div class="h-100 flex-col" x-data="{ isEditing: false }">
    <header class="main-header">
        <div class="header-left">
            <span class="status-pill status-text-lg" x-text="isEditing ? 'EDITING' : 'IDLE'">IDLE</span>
            <h4>{{ name }}</h4>
        </div>
        <div class="actions">
            <!-- Edit (Toggle) -->
            <button class="contrast" x-show="!isEditing" @click="isEditing = true; window.startEditing()">
                Edit
            </button>
            <button class="contrast" x-show="isEditing" @click="isEditing = false; window.discardEditing()">
                Discard
            </button>

            <!-- Run -->
            <button class="primary" hx-post="/run/{{ name }}" hx-target="#terminal-container" hx-swap="innerHTML">
                Run Playbook
            </button>

            <!-- Save -->
            <button class="contrast" @click="saveFile(); isEditing = false; window.setEditorReadOnly(true)">
                Save
            </button>

            <!-- Schedule -->
            <button class="contrast">
                Schedule
            </button>

            <!-- Delete Button -->
            <button class="danger" hx-delete="/playbook/{{ name }}"
                hx-confirm="Are you sure you want to delete {{ name }}? This cannot be undone."
                hx-target="#main-content">
                Delete
            </button>
        </div>
    </header>

    <div class="content-area">
        <!-- Editor Pane -->
        <div class="editor-pane">
            <div id="editor"></div>
        </div>

        <!-- Terminal Pane -->
        <div class="terminal-pane">
            <div id="terminal-container">
                <div class="waiting-text">Waiting for execution...</div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form for HTMX/JS to store state -->
<textarea id="hidden-content" class="d-none">{{ content }}</textarea>

<script>
    (function () {
        function initAce() {
            var editorDiv = document.getElementById("editor");
            if (!editorDiv) return;

            // Prevent double init
            if (editorDiv.classList.contains("ace_editor")) return;

            // Wait for x-show / DOM paint
            setTimeout(function () {
                var editor = ace.edit("editor");
                editor.setTheme("ace/theme/tomorrow_night_eighties");
                editor.session.setMode("ace/mode/yaml");

                // Default to Read Only
                editor.setReadOnly(true);

                // Internal state for undo
                var originalContent = "";

                // Global Helpers
                window.setEditorReadOnly = function (readonly) {
                    editor.setReadOnly(readonly);
                    if (!readonly) editor.focus();
                };

                window.startEditing = function () {
                    originalContent = editor.getValue();
                    editor.setReadOnly(false);
                    editor.focus();
                };

                window.discardEditing = function () {
                    editor.setValue(originalContent, -1);
                    editor.setReadOnly(true);
                };

                // Ensure text is visible
                editor.setShowPrintMargin(false);

                var contentArea = document.getElementById("hidden-content");
                if (contentArea) {
                    editor.setValue(contentArea.value, -1);
                }

                // Force resize
                editor.resize();

                // Save handler
                window.saveFile = function () {
                    var content = editor.getValue();
                    htmx.ajax('POST', '/playbook/{{ name }}', {
                        values: { content: content },
                        swap: 'none'
                    }).then(() => {
                        // Update original content to the new saved state
                        originalContent = content;
                    });
                };
            }, 100);
        }

        // Run Init
        initAce();
    })();
</script>