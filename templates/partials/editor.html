<div class="h-100 flex-col" x-data="{ 
    isEditing: false, 
    showScheduleModal: false, 
    showLaunchModal: false,
    launchMode: 'run',
    cronExpression: '0 3 * * *',
    launchParams: {
        limit: ['all'],
        availableTargets: { hosts: [], groups: [], all: ['all'] },
        showTargets: false,
        tags: '',
        verbosity: 0,
        extraVars: []
    },
    scheduleTarget: 'all',
    showScheduleTargets: false,
    toggleTarget(t) {
        if (t === 'all') {
            this.launchParams.limit = ['all'];
        } else {
            // Remove 'all' if selecting specific
            this.launchParams.limit = this.launchParams.limit.filter(x => x !== 'all');
            if (this.launchParams.limit.includes(t)) {
                this.launchParams.limit = this.launchParams.limit.filter(x => x !== t);
            } else {
                this.launchParams.limit.push(t);
            }
            if (this.launchParams.limit.length === 0) this.launchParams.limit = ['all'];
        }
    },
    async fetchTargets() {
        try {
            const res = await fetch('/api/inventory/targets');
            if (res.ok) this.launchParams.availableTargets = await res.json();
        } catch(e) { console.log(e); }
    },
    addExtraVar() {
        this.launchParams.extraVars.push({ key: '', value: '' });
    },
    removeExtraVar(index) {
        this.launchParams.extraVars.splice(index, 1);
    },
    getExtraVarsJson() {
        let obj = {};
        this.launchParams.extraVars.forEach(v => {
            if (v.key) obj[v.key] = v.value;
        });
        return JSON.stringify(obj);
    }
}">
    <style>
        /* Fix Ace Editor Alignment */
        /* Fix Ace Editor Alignment */
        .ace_editor,
        .ace_editor * {
            font-family: 'Geist Mono', 'SF Mono', 'Monaco', 'Menlo', monospace !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
        }

        /* Ensure gutter is visible but keep original colors */
        .ace_gutter-cell {
            padding-left: 10px !important;
            padding-right: 10px !important;
            display: block !important;
            /* Restore block display for visibility */
        }

        .ace_scroller {
            line-height: 24px !important;
        }

        /* Hide fold widgets */
        .ace_fold-widget {
            display: none !important;
        }

        /* Padding for top text */
        .ace_gutter {
            padding-top: 12px !important;
        }

        .ace_scroller {
            top: 12px !important;
        }
    </style>

    <!-- Schedule Modal -->
    <dialog :open="showScheduleModal">
        <article>
            <header>
                <a href="#close" aria-label="Close" class="close" @click="showScheduleModal = false"></a>
                <h5>Schedule {{ name }}</h5>
            </header>
            <p>Run this playbook automatically using a Cron expression.</p>
            <input type="text" x-model="cronExpression" placeholder="* * * * *">
            <small>Example: <code>0 3 * * *</code> (Every day at 3am)</small>
            <footer>
                <div style="margin-bottom: 16px;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 500; color: #444; margin-bottom: 4px;">Target</label>

                    <div x-data="{
                        open: false,
                        top: 0,
                        left: 0,
                        width: 0,
                        toggle() {
                            if (this.open) {
                                this.open = false;
                            } else {
                                const rect = this.$refs.trigger.getBoundingClientRect();
                                this.top = rect.bottom + 4;
                                this.left = rect.left;
                                this.width = rect.width;
                                this.open = true;
                            }
                        },
                        get currentLabel() {
                            const target = this.$data.$root.scheduleTarget;
                            const targets = this.$data.$root.launchParams.availableTargets;
                            if (!target || target === 'all') return 'All Hosts';
                            if (targets.groups && targets.groups.includes(target)) return target;
                            const host = targets.hosts && targets.hosts.find(h => h.alias === target);
                            return host ? host.alias + ' (host)' : target;
                        }
                    }" @click.outside="open = false" @scroll.window="open = false" @resize.window="open = false"
                        class="geist-select-container">

                        <!-- Inject CSS locally to ensure it works -->
                        <style>
                            .geist-select-container {
                                position: relative;
                                width: 100%;
                            }

                            .geist-select-trigger {
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                width: 100%;
                                height: 32px;
                                padding: 0 8px 0 12px;
                                background: #ffffff;
                                border: 1px solid #eaeaea;
                                border-radius: 6px;
                                font-size: 13px;
                                color: #000;
                                cursor: pointer;
                                transition: all 0.15s ease;
                                user-select: none;
                                box-sizing: border-box;
                            }

                            .geist-select-trigger:hover {
                                border-color: #888;
                            }

                            .geist-select-trigger:focus-within,
                            .geist-select-trigger[aria-expanded="true"] {
                                border-color: #000000;
                                outline: none;
                            }

                            .geist-select-dropdown {
                                position: absolute;
                                top: calc(100% + 4px);
                                left: 0;
                                width: 100%;
                                min-width: 220px;
                                background: #ffffff;
                                border: 1px solid #eaeaea;
                                border-radius: 6px;
                                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                                z-index: 9999;
                                max-height: 300px;
                                overflow-y: auto;
                                padding: 4px;
                            }

                            .geist-select-dropdown[style*="display: none"] {
                                display: none !important;
                            }

                            .geist-select-header {
                                font-size: 11px;
                                text-transform: uppercase;
                                letter-spacing: 0.05em;
                                color: #888;
                                padding: 8px 12px 4px;
                                font-weight: 500;
                                pointer-events: none;
                            }

                            .geist-select-option {
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                padding: 6px 12px;
                                font-size: 13px;
                                color: #000;
                                cursor: pointer;
                                border-radius: 4px;
                                transition: background 0.15s;
                            }

                            .geist-select-option:hover {
                                background: #fafafa;
                            }

                            .geist-select-option.selected {
                                font-weight: 500;
                                background: #fafafa;
                            }

                            .geist-select-option .check-icon {
                                margin-left: auto;
                                opacity: 0;
                                stroke: #000;
                            }

                            .geist-select-option.selected .check-icon {
                                opacity: 1;
                            }
                        </style>

                        <div x-ref="trigger" @click="toggle()" class="geist-select-trigger" :aria-expanded="open">
                            <span x-text="currentLabel"
                                style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;"></span>
                            <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #666;"></i>
                        </div>

                        <div x-show="open" x-transition class="geist-select-dropdown"
                            style="position: absolute; top: 100%; left: 0; width: 100%; margin-top: 4px;">
                            <!-- All -->
                            <div class="geist-select-option" :class="{ 'selected': scheduleTarget === 'all' }"
                                @click="scheduleTarget = 'all'; open = false">
                                <i data-lucide="globe" style="width: 14px; height: 14px; color: #666;"></i>
                                <span>All Hosts</span>
                                <i data-lucide="check" class="check-icon" style="width: 14px; height: 14px;"></i>
                            </div>

                            <!-- Groups -->
                            <template
                                x-if="launchParams.availableTargets.groups && launchParams.availableTargets.groups.length > 0">
                                <div>
                                    <div class="geist-select-header">Groups</div>
                                    <template x-for="g in launchParams.availableTargets.groups" :key="g">
                                        <div class="geist-select-option" :class="{ 'selected': scheduleTarget === g }"
                                            @click="scheduleTarget = g; open = false">
                                            <i data-lucide="users" style="width: 14px; height: 14px; color: #666;"></i>
                                            <span x-text="g"></span>
                                            <i data-lucide="check" class="check-icon"
                                                style="width: 14px; height: 14px;"></i>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <!-- Servers -->
                            <template
                                x-if="launchParams.availableTargets.hosts && launchParams.availableTargets.hosts.length > 0">
                                <div>
                                    <div class="geist-select-header">Servers</div>
                                    <template x-for="h in launchParams.availableTargets.hosts" :key="h.alias">
                                        <div class="geist-select-option"
                                            :class="{ 'selected': scheduleTarget === h.alias }"
                                            @click="scheduleTarget = h.alias; open = false">
                                            <i data-lucide="server" style="width: 14px; height: 14px; color: #666;"></i>
                                            <span x-text="h.alias"></span>
                                            <span style="color: #999; font-size: 11px; margin-left: 4px;">(host)</span>
                                            <i data-lucide="check" class="check-icon"
                                                style="width: 14px; height: 14px;"></i>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 8px;">
                    <button style="background-color: #000; border-color: #000; color: #fff;" @click='
                        htmx.ajax("POST", "/schedule", {
                            values: { playbook: {{ name | tojson | forceescape }}, cron: cronExpression, target: scheduleTarget || "all" },
                            swap: "none"
                        });
                        showScheduleModal = false;
                    '>
                        <i data-lucide="calendar-check" style="width: 14px; height: 14px; margin-right: 6px;"></i> Save
                        Schedule
                    </button>
                </div>
            </footer>
        </article>
    </dialog>

    <!-- Launchpad Modal -->
    <dialog :open="showLaunchModal">
        <article style="max-width: 600px; width: 100%;">
            <header>
                <a href="#close" aria-label="Close" class="close" @click="showLaunchModal = false"></a>
                <h5 x-text="launchMode === 'check' ? 'Dry Run: ' + '{{ name }}' : 'Launch: ' + '{{ name }}'"></h5>
            </header>

            <form @submit.prevent="
                let vals = {
                    limit: Array.isArray(launchParams.limit) ? launchParams.limit.join(',') : launchParams.limit,
                    tags: launchParams.tags,
                    verbosity: launchParams.verbosity,
                    extra_vars: getExtraVarsJson()
                };
                htmx.ajax('POST', (launchMode === 'check' ? '/check/{{ name | safe }}' : '/run/{{ name | safe }}'), {
                    values: vals,
                    target: '#terminal-container',
                    swap: 'innerHTML'
                });
                showLaunchModal = false;
            ">
                <div class="grid">
                    <div style="position: relative;">
                        <label>Target Hosts / Groups</label>
                        <div class="custom-select-trigger" @click="launchParams.showTargets = !launchParams.showTargets"
                            :class="{ 'expanded': launchParams.showTargets }"
                            style="cursor: pointer; padding: 10px; border: 1px solid var(--ds-gray-200); border-radius: 6px; background: var(--ds-background-100); display: flex; justify-content: space-between; align-items: center; min-height: 42px;">
                            <span x-text="launchParams.limit.join(', ')"
                                style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;"></span>
                            <i data-lucide="chevron-down" style="width: 16px; height: 16px;"></i>
                        </div>

                        <div x-show="launchParams.showTargets" x-transition:enter="transition ease-out duration-100"
                            x-transition:enter-start="transform opacity-0 scale-95"
                            x-transition:enter-end="transform opacity-100 scale-100"
                            @click.away="launchParams.showTargets = false" class="custom-select-dropdown"
                            style="position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; background: white; border: 1px solid var(--ds-gray-200); border-radius: 6px; margin-top: 4px; max-height: 250px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">

                            <style>
                                .select-item:hover {
                                    background: var(--ds-background-200) !important;
                                }

                                .select-item input[type="checkbox"] {
                                    pointer-events: none;
                                }
                            </style>

                            <div class="select-item" @click="toggleTarget('all')"
                                style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"
                                :style="launchParams.limit.includes('all') ? 'background: var(--ds-blue-100); color: var(--ds-blue-700); font-weight: 500;' : ''">
                                <input type="checkbox" :checked="launchParams.limit.includes('all')"
                                    style="margin-bottom: 0;">
                                <span>all</span>
                            </div>

                            <template x-if="launchParams.availableTargets.groups.length > 0">
                                <div>
                                    <div
                                        style="padding: 4px 12px; font-size: 0.75rem; color: var(--ds-gray-500); font-weight: 600; text-transform: uppercase;">
                                        Groups</div>
                                    <template x-for="g in launchParams.availableTargets.groups" :key="g">
                                        <div class="select-item" @click="toggleTarget(g)"
                                            style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px;"
                                            :style="launchParams.limit.includes(g) ? 'background: var(--ds-blue-100); color: var(--ds-blue-700);' : ''">
                                            <input type="checkbox" :checked="launchParams.limit.includes(g)"
                                                style="margin-bottom: 0;">
                                            <span x-text="g"></span>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <template x-if="launchParams.availableTargets.hosts.length > 0">
                                <div>
                                    <div
                                        style="padding: 4px 12px; font-size: 0.75rem; color: var(--ds-gray-500); font-weight: 600; text-transform: uppercase;">
                                        Hosts</div>
                                    <template x-for="h in launchParams.availableTargets.hosts" :key="h.alias">
                                        <div class="select-item" @click="toggleTarget(h.alias)"
                                            style="padding: 8px 12px; cursor: pointer; display: flex; align-items: center; gap: 10px;"
                                            :style="launchParams.limit.includes(h.alias) ? 'background: var(--ds-blue-100); color: var(--ds-blue-700);' : ''">
                                            <input type="checkbox" :checked="launchParams.limit.includes(h.alias)"
                                                style="margin-bottom: 0;">
                                            <span x-text="h.alias"></span>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                    <label>
                        Tags
                        <input type="text" x-model="launchParams.tags" placeholder="e.g. deploy, !db">
                    </label>
                </div>

                <label>
                    Verbosity
                    <select x-model="launchParams.verbosity">
                        <option value="0">Normal</option>
                        <option value="1">Verbose (-v)</option>
                        <option value="2">More Verbose (-vv)</option>
                        <option value="3">Debug (-vvv)</option>
                    </select>
                </label>

                <div style="margin-top: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong>Extra Variables</strong>
                        <button type="button" class="outline" style="padding: 2px 8px; font-size: 0.8rem;"
                            @click="addExtraVar()">
                            <i data-lucide="plus" style="width: 12px; height: 12px; margin-right: 4px;"></i> Add Var
                        </button>
                    </div>

                    <template x-for="(v, index) in launchParams.extraVars" :key="index">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start;">
                            <input type="text" x-model="v.key" placeholder="Key" style="margin-bottom: 0;">
                            <input type="text" x-model="v.value" placeholder="Value" style="margin-bottom: 0;">
                            <button type="button" class="secondary outline btn-icon"
                                style="padding: 4px; border-color: #ff4444; color: #ff4444;"
                                @click="removeExtraVar(index)">
                                <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                    </template>
                    <div x-show="launchParams.extraVars.length === 0"
                        style="color: #868e96; font-size: 0.9rem; text-align: center; padding: 10px; border: 1px dashed #dee2e6; border-radius: 4px;">
                        No extra variables defined.
                    </div>
                </div>

                <footer style="margin-top: 2rem;">
                    <button type="submit">
                        <i data-lucide="check-circle" style="width: 14px; height: 14px; margin-right: 6px;"
                            x-show="launchMode === 'check'"></i>
                        <i data-lucide="rocket" style="width: 14px; height: 14px; margin-right: 6px;"
                            x-show="launchMode === 'run'"></i>
                        <span x-text="launchMode === 'check' ? 'Run Check' : 'Launch'"></span>
                    </button>
                </footer>
            </form>
        </article>
    </dialog>
    <header class="main-header">
        <div class="header-left">
            <h4>{{ name }}</h4>
        </div>
        <div class="actions">
            <!-- Edit (Toggle) - Admin Only -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="secondary" x-show="!isEditing" @click="isEditing = true; window.startEditing()"
                title="Edit Playbook">
                <i data-lucide="edit-3" style="width: 14px; height: 14px;"></i> Edit
            </button>
            <button class="secondary" x-show="isEditing" @click="isEditing = false; window.discardEditing()"
                title="Discard Changes">
                <i data-lucide="x" style="width: 14px; height: 14px;"></i> Discard
            </button>
            {% endif %}

            <!-- Check/Run/Schedule - Admin & Operator -->
            {% if request.state.user and request.state.user.role in ['admin', 'operator'] %}
            <!-- Check (Dry Run) -->
            <button class="secondary"
                @click="launchMode = 'check'; fetchTargets(); launchParams.showTargets = false; showLaunchModal = true"
                title="Dry Run (Check Mode)">
                <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i> Check
            </button>

            <!-- Run -->
            <button class="primary"
                @click="launchMode = 'run'; fetchTargets(); launchParams.showTargets = false; showLaunchModal = true">
                <i data-lucide="play" style="width: 14px; height: 14px;"></i> Run
            </button>
            {% endif %}

            <!-- Save - Admin Only -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="secondary" @click="saveFile(); isEditing = false; window.setEditorReadOnly(true)"
                title="Save Changes">
                <i data-lucide="save" style="width: 14px; height: 14px;"></i> Save
            </button>
            {% endif %}

            <!-- Schedule (Modal Trigger) - Admin & Operator -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="btn-icon" @click="showScheduleModal = true; fetchTargets()" title="Schedule">
                <i data-lucide="calendar"></i>
            </button>
            {% endif %}

            <!-- History - All -->
            <button class="btn-icon" hx-get="/history/{{ name | safe }}" hx-target="body" hx-swap="beforeend"
                title="View History">
                <i data-lucide="clock"></i>
            </button>

            <!-- Install Roles - Admin Only -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="btn-icon" hx-post="/playbooks/{{ name | safe }}/install-requirements"
                hx-target="#terminal-container" hx-swap="innerHTML" title="Install Ansible Galaxy dependencies">
                <i data-lucide="download"></i>
            </button>

            <!-- Delete Button -->
            <button class="btn-icon" style="color: var(--sible-error); border-color: var(--ds-gray-200);"
                hx-delete="/playbooks/{{ name | safe }}"
                hx-confirm="Are you sure you want to delete {{ name }}? This cannot be undone."
                hx-target="#main-content" title="Delete Playbook">
                <i data-lucide="trash-2"></i>
            </button>
            {% endif %}
        </div>
    </header>

    <div class="content-area">
        <!-- Editor Pane -->
        <div class="editor-pane code-editor-wrapper" style="border: none; box-shadow: none;">
            <div id="editor"></div>
        </div>

        <!-- Terminal Pane -->
        <div class="terminal-pane">
            <div id="terminal-container" style="background-color: #ffffff; color: #000000;">
                <div class="waiting-text" style="color: #666;">Waiting for execution...</div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form for HTMX/JS to store state -->
<textarea id="hidden-content" class="d-none">{{ content }}</textarea>

<script>
    (function () {
        function initAce() {
            var editorDiv = document.getElementById("editor");
            if (!editorDiv) return;

            // Prevent double init
            if (editorDiv.classList.contains("ace_editor")) return;

            // Wait for x-show / DOM paint
            setTimeout(function () {
                var editor = ace.edit("editor");
                editor.setTheme("ace/theme/chrome");
                editor.session.setMode("ace/mode/yaml");

                // Default to Read Only
                editor.setReadOnly(true);

                // Internal state for undo
                var originalContent = "";

                // Global Helpers
                window.setEditorReadOnly = function (readonly) {
                    editor.setReadOnly(readonly);
                    if (!readonly) editor.focus();
                };

                window.startEditing = function () {
                    originalContent = editor.getValue();
                    editor.setReadOnly(false);
                    editor.focus();
                };

                window.discardEditing = function () {
                    editor.setValue(originalContent, -1);
                    editor.setReadOnly(true);
                };

                // Ensure text is visible
                editor.setShowPrintMargin(false);

                var contentArea = document.getElementById("hidden-content");
                if (contentArea) {
                    editor.setValue(contentArea.value, -1);
                }

                // Force resize
                editor.resize();

                // Save handler
                window.saveFile = function () {
                    var content = editor.getValue();
                    htmx.ajax('POST', '/playbooks/{{ name }}', {
                        values: { content: content },
                        swap: 'none'
                    }).then(() => {
                        // Update original content to the new saved state
                        originalContent = content;
                    });
                };

                // Linting Logic
                function debounce(func, wait) {
                    let timeout;
                    return function (...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                }

                function lintCode() {
                    var content = editor.getValue();
                    // Use URLSearchParams for form data
                    var formData = new URLSearchParams();
                    formData.append('content', content);

                    fetch('/lint', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(annotations => {
                            editor.getSession().setAnnotations(annotations);
                        })
                        .catch(e => console.error("Lint error", e));
                }

                var debouncedLint = debounce(lintCode, 1000);

                editor.session.on('change', function () {
                    if (!editor.getReadOnly()) {
                        debouncedLint();
                    }
                });

                // Initial lint on edit start
                var _startEditing = window.startEditing;
                window.startEditing = function () {
                    _startEditing();
                    lintCode();
                };
            }, 100);
        }

        // Run Init
        initAce();
    })();
</script>