<div class="h-100 flex-col" x-data="{ 
    isEditing: false, 
    showScheduleModal: false, 
    showLaunchModal: false,
    launchMode: 'run',
    cronExpression: '0 3 * * *',
    launchParams: {
        limit: ['all'],
        availableTargets: { hosts: [], groups: [], all: ['all'] },
        showTargets: false,
        tags: '',
        verbosity: 0
    },
    scheduleTargets: ['all'],
    showScheduleTargets: false,
    toggleScheduleTarget(t) {
        if (t === 'all') {
            this.scheduleTargets = ['all'];
        } else {
            this.scheduleTargets = this.scheduleTargets.filter(x => x !== 'all');
            if (this.scheduleTargets.includes(t)) {
                this.scheduleTargets = this.scheduleTargets.filter(x => x !== t);
            } else {
                this.scheduleTargets.push(t);
            }
            if (this.scheduleTargets.length === 0) this.scheduleTargets = ['all'];
        }
    },
    toggleTarget(t) {
        if (t === 'all') {
            this.launchParams.limit = ['all'];
        } else {
            // Remove 'all' if selecting specific
            this.launchParams.limit = this.launchParams.limit.filter(x => x !== 'all');
            if (this.launchParams.limit.includes(t)) {
                this.launchParams.limit = this.launchParams.limit.filter(x => x !== t);
            } else {
                this.launchParams.limit.push(t);
            }
            if (this.launchParams.limit.length === 0) this.launchParams.limit = ['all'];
        }
    },
    async fetchTargets() {
        try {
            const res = await fetch('/api/inventory/targets');
            if (res.ok) this.launchParams.availableTargets = await res.json();
        } catch(e) { console.error(e); }
    },
    getExtraVarsJson() {
        let obj = {};
        const dynInput = document.querySelector('#playbook-variables-container input[name=extra_vars]');
        if (dynInput && dynInput.value) { try { Object.assign(obj, JSON.parse(dynInput.value)); } catch(e) {} }
        return JSON.stringify(obj);
    }
}" x-init="fetchTargets(); lucide.createIcons()">
    <style>
        /* Fix Ace Editor Alignment */
        /* Fix Ace Editor Alignment */
        .ace_editor,
        .ace_editor * {
            font-family: 'Geist Mono', 'SF Mono', 'Monaco', 'Menlo', monospace !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
        }

        /* Ensure gutter is visible but keep original colors */
        .ace_gutter-cell {
            padding-left: 10px !important;
            padding-right: 10px !important;
            display: block !important;
            /* Restore block display for visibility */
        }

        .ace_scroller {
            line-height: 24px !important;
        }

        /* Hide fold widgets */
        .ace_fold-widget {
            display: none !important;
        }

        /* Padding for top text */
        .ace_gutter {
            padding-top: 12px !important;
        }

        .ace_scroller {
            top: 12px !important;
        }
    </style>

    <!-- Schedule Modal -->
    <dialog :open="showScheduleModal">
        <article style="max-width: 600px; width: 100%;">
            <header style="display: flex; justify-content: space-between; align-items: center; border-bottom: none;">
                <h5 style="margin: 0;">Schedule Playbook</h5>
                <button type="button" aria-label="Close" @click="showScheduleModal = false" class="action-btn">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </header>

            <section style="padding: 1rem 0;">
                <p style="color: var(--ds-gray-600); font-size: 14px; margin-bottom: 1.5rem;">
                    Run <strong>{{ name }}</strong> automatically using a Cron expression.
                </p>

                <label style="margin-bottom: 2rem;">
                    <span
                        style="display: block; font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 4px;">Cron
                        Expression</span>
                    <input type="text" x-model="cronExpression" placeholder="* * * * *" required
                        style="margin-bottom: 8px; background: var(--surface-primary); color: var(--text-primary); border: 1px solid var(--border-subtle);">
                    <div style="color: var(--text-muted); font-size: 11px;">
                        Example: <code
                            style="background: var(--surface-secondary); padding: 2px 4px; border-radius: 4px; font-size: 10px; color: var(--text-primary);">0 3 * * *</code>
                        (Every day at 3am)
                    </div>
                </label>

                <div style="margin-bottom: 2rem;" x-init="lucide.createIcons()">
                    <span
                        style="display: block; font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px;">Target</span>
                    <div x-data="{ initialTargets: scheduleTargets.join(',') }"
                        @targets-changed="scheduleTargets = $event.detail">
                        {% with picker_id='schedule-target-picker' %}
                        {% include "partials/target_picker.html" %}
                        {% endwith %}
                    </div>
                </div>

                <!-- Dynamic Variables -->
                <div style="margin-bottom: 1.5rem;">
                    <span
                        style="display: block; font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px;">Variables</span>
                    <div id="schedule-variables-container" hx-get="/api/playbook-vars/{{ name | safe }}"
                        hx-trigger="load, intersect once" hx-swap="innerHTML">
                        <div style="padding: 10px 0; color: var(--text-muted); font-size: 0.9em;">
                            <span aria-busy="true" style="font-size: 0.9em;">Loading variables...</span>
                        </div>
                    </div>
                </div>



                <footer
                    style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 1rem; border-top: none; padding: 0;">
                    <button class="primary" style="padding: 10px 20px; border-radius: 6px;" @click='
                            let extraVars = "{}";
                            const dynInput = document.querySelector("#schedule-variables-container input[name=extra_vars]");
                            if (dynInput && dynInput.value) { extraVars = dynInput.value; }
                            htmx.ajax("POST", "/schedule", { values: { playbook: {{ name | tojson | forceescape }}, cron: cronExpression, target: scheduleTargets.join(",") || "all", extra_vars: extraVars }, swap: "none" }); 
                            showScheduleModal = false;
                        '>
                        <i data-lucide="calendar-check" style="width: 14px; height: 14px; margin-right: 6px;"></i> Save
                        Schedule
                    </button>
                    <button class="secondary outline" @click="showScheduleModal = false"
                        style="padding: 10px 20px; border-radius: 6px;">Cancel</button>
                </footer>
            </section>
        </article>
    </dialog>

    <!-- Launchpad Modal -->
    <dialog :open="showLaunchModal">
        <article style="max-width: 600px; width: 100%;">
            <header style="display: flex; justify-content: space-between; align-items: center; border-bottom: none;">
                <h5 x-text="launchMode === 'check' ? 'Dry Run: ' + '{{ name }}' : 'Launch: ' + '{{ name }}'"
                    style="margin: 0;"></h5>
                <button type="button" aria-label="Close" @click="showLaunchModal = false" class="action-btn">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </header>


            <form
                @submit.prevent=" let vals={ limit: Array.isArray(launchParams.limit) ? launchParams.limit.join(',') : launchParams.limit, tags: launchParams.tags, verbosity: launchParams.verbosity, extra_vars: getExtraVarsJson() }; htmx.ajax('POST', (launchMode==='check' ? '/check/{{ name | safe }}' : '/run/{{ name | safe }}' ), { values: vals, target: '#terminal-container', swap: 'innerHTML' }); showLaunchModal=false; ">
                <div style="margin-bottom: 2rem; position: relative; overflow: visible;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 4px;">Target
                        Hosts / Groups</label>
                    <div x-data="{ initialTargets: launchParams.limit.join(',') }"
                        @targets-changed="launchParams.limit = $event.detail">
                        {% with picker_id='launch-target-picker' %}
                        {% include "partials/target_picker.html" %}
                        {% endwith %}
                    </div>
                </div>

                <div class="grid">
                    <label>
                        Tags
                        <input type="text" x-model="launchParams.tags" placeholder="e.g. deploy, !db">
                    </label>
                    <label>
                        Verbosity
                        <select x-model="launchParams.verbosity" style="height: 42px;">
                            <option value="0">Normal</option>
                            <option value="1">Verbose (-v)</option>
                            <option value="2">More Verbose (-vv)</option>
                            <option value="3">Debug (-vvv)</option>
                        </select>
                    </label>
                </div>

                <div style="margin-top: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="font-size: 13px;">Variables</strong>
                    </div>

                    <!-- Dynamic Variables (loaded from playbook) -->
                    <div id="playbook-variables-container" hx-get="/api/playbook-vars/{{ name | safe }}"
                        hx-trigger="load, intersect once" hx-swap="innerHTML">
                        <div style="padding: 10px 0; color: #888; font-size: 0.9em;">
                            <span aria-busy="true" style="font-size: 0.9em;">Loading variables...</span>
                        </div>
                    </div>

                </div>

                <footer style="margin-top: 2rem; padding: 0; border-top: none;">
                    <button type="submit" class="primary" style="width: 100%; height: 42px;">
                        <i data-lucide="rocket" style="width: 14px; height: 14px; margin-right: 6px;"></i>
                        <span x-text="launchMode === 'check' ? 'Launch Dry Run' : 'Launch Playbook'"></span>
                    </button>
                </footer>
            </form>
        </article>
    </dialog>
    <header class="main-header">
        <div class="header-left">
            <h4>{{ name }}</h4>
        </div>
        <div class="actions flex-row">
            <!-- Edit (Toggle) - Admin Only -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="secondary" x-show="!isEditing" @click="isEditing = true; window.startEditing()"
                title="Edit Playbook">
                <i data-lucide="edit-3" style="width: 14px; height: 14px;"></i> Edit
            </button>
            <button class="secondary" x-show="isEditing" @click="isEditing = false; window.discardEditing()"
                title="Discard Changes">
                <i data-lucide="x" style="width: 14px; height: 14px;"></i> Discard
            </button>
            {% endif %}

            <!-- Check/Run/Schedule - Admin & Operator -->
            {% if request.state.user and request.state.user.role in ['admin', 'operator'] %}
            <!-- Check (Dry Run) -->
            <button class="secondary"
                @click="launchMode = 'check'; fetchTargets(); launchParams.showTargets = false; showLaunchModal = true"
                title="Dry Run (Check Mode)">
                <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i> Check
            </button>

            <!-- Run -->
            <button class="primary"
                @click="launchMode = 'run'; fetchTargets(); launchParams.showTargets = false; showLaunchModal = true">
                <i data-lucide="play" style="width: 14px; height: 14px;"></i> Run
            </button>
            {% endif %}

            <!-- Save - Admin Only -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="secondary" @click="saveFile(); isEditing = false; window.setEditorReadOnly(true)"
                title="Save Changes">
                <i data-lucide="save" style="width: 14px; height: 14px;"></i> Save
            </button>
            {% endif %}

            <!-- Schedule (Modal Trigger) - Admin & Operator -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="action-btn" @click="showScheduleModal = true; fetchTargets()" title="Schedule">
                <i data-lucide="calendar"></i>
            </button>
            {% endif %}


            <!-- History - All -->
            <button class="action-btn" hx-get="/history/{{ name | safe }}" hx-target="body" hx-swap="beforeend"
                title="View History">
                <i data-lucide="clock"></i>
            </button>


            <!-- Install Roles - Admin Only -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="action-btn" hx-post="/playbooks/{{ name | safe }}/install-requirements"
                hx-target="#terminal-container" hx-swap="innerHTML" title="Install Ansible Galaxy dependencies">
                <i data-lucide="download"></i>
            </button>


            <!-- Delete Button -->
            <button class="action-btn" style="color: var(--sible-error);" hx-delete="/playbooks/{{ name | safe }}"
                hx-confirm="Are you sure you want to delete {{ name }}? This cannot be undone."
                hx-target="#main-content" title="Delete Playbook">
                <i data-lucide="trash-2"></i>
            </button>

            {% endif %}
        </div>
    </header>

    <div class="content-area flex-1">
        <!-- Editor Pane -->
        <div class="editor-pane flex-1">
            <div id="editor"></div>
        </div>

        <!-- Terminal Pane -->
        <div class="terminal-pane flex-1">
            <div id="terminal-container">
                <div class="waiting-text" style="color: var(--text-muted);">Waiting for execution...</div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form for HTMX/JS to store state -->
<textarea id="hidden-content" style="display: none;">{{ content }}</textarea>

<script>
    (function () {
        function initAce() {
            var editorDiv = document.getElementById("editor");
            if (!editorDiv) return;

            // Prevent double init
            if (editorDiv.classList.contains("ace_editor")) return;

            var editor = ace.edit("editor");
            editor.session.setMode("ace/mode/yaml");
            editor.setReadOnly(true);
            editor.setShowPrintMargin(false);

            // Theme Handling
            function updateTheme() {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                // Catppuccin Mocha dark theme
                editor.setTheme(isDark ? "ace/theme/catppuccin_mocha" : "ace/theme/chrome");
            }
            updateTheme();

            // React to theme changes
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                        updateTheme();
                    }
                });
            });
            observer.observe(document.documentElement, { attributes: true });

            // Internal state for undo
            var originalContent = "";

            // Global Helpers
            window.setEditorReadOnly = function (readonly) {
                editor.setReadOnly(readonly);
                if (!readonly) editor.focus();
            };

            window.startEditing = function () {
                originalContent = editor.getValue();
                editor.setReadOnly(false);
                editor.focus();
            };

            window.discardEditing = function () {
                editor.setValue(originalContent, -1);
                editor.setReadOnly(true);
            };

            var contentArea = document.getElementById("hidden-content");
            if (contentArea) {
                editor.setValue(contentArea.value, -1);
            }

            // Force resize
            editor.resize();

            // Save handler
            window.saveFile = function () {
                var content = editor.getValue();
                htmx.ajax('POST', '/playbooks/{{ name }}', {
                    values: { content: content },
                    swap: 'none'
                }).then(() => {
                    originalContent = content;
                });
            };

            // Linting Logic
            function lintCode() {
                var content = editor.getValue();
                var formData = new URLSearchParams();
                formData.append('content', content);

                fetch('/lint', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(annotations => {
                        editor.getSession().setAnnotations(annotations);
                    })
                    .catch(e => console.error("Lint error", e));
            }

            editor.session.on('change', function () {
                if (!editor.getReadOnly()) {
                    // Simple debounce
                    clearTimeout(editor.lintTimeout);
                    editor.lintTimeout = setTimeout(lintCode, 1000);
                }
            });

            // Initial lint on edit start
            var _startEditing = window.startEditing;
            window.startEditing = function () {
                _startEditing();
                lintCode();
            };
        }

        // Run Init - Use requestAnimationFrame to ensure DOM is ready
        requestAnimationFrame(initAce);
    })();
</script>