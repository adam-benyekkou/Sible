<div class="h-100 flex-col" x-data="{ 
    isEditing: false, 
    showScheduleModal: false, 
    showLaunchModal: false,
    launchMode: 'run',
    cronExpression: '0 3 * * *',
    launchParams: {
        limit: ['all'],
        availableTargets: { hosts: [], groups: [], all: ['all'] },
        showTargets: false,
        tags: '',
        verbosity: 0,
        extraVars: []
    },
    scheduleTargets: ['all'],
    showScheduleTargets: false,
    toggleScheduleTarget(t) {
        if (t === 'all') {
            this.scheduleTargets = ['all'];
        } else {
            this.scheduleTargets = this.scheduleTargets.filter(x => x !== 'all');
            if (this.scheduleTargets.includes(t)) {
                this.scheduleTargets = this.scheduleTargets.filter(x => x !== t);
            } else {
                this.scheduleTargets.push(t);
            }
            if (this.scheduleTargets.length === 0) this.scheduleTargets = ['all'];
        }
    },
    toggleTarget(t) {
        if (t === 'all') {
            this.launchParams.limit = ['all'];
        } else {
            // Remove 'all' if selecting specific
            this.launchParams.limit = this.launchParams.limit.filter(x => x !== 'all');
            if (this.launchParams.limit.includes(t)) {
                this.launchParams.limit = this.launchParams.limit.filter(x => x !== t);
            } else {
                this.launchParams.limit.push(t);
            }
            if (this.launchParams.limit.length === 0) this.launchParams.limit = ['all'];
        }
    },
    async fetchTargets() {
        try {
            const res = await fetch('/api/inventory/targets');
            if (res.ok) this.launchParams.availableTargets = await res.json();
        } catch(e) { console.log(e); }
    },
    addExtraVar() {
        this.launchParams.extraVars.push({ key: '', value: '' });
    },
    removeExtraVar(index) {
        this.launchParams.extraVars.splice(index, 1);
    },
    getExtraVarsJson() {
        let obj = {};
        this.launchParams.extraVars.forEach(v => {
            if (v.key) obj[v.key] = v.value;
        });
        return JSON.stringify(obj);
    }
}" x-init="fetchTargets(); lucide.createIcons()">
    <style>
        /* Fix Ace Editor Alignment */
        /* Fix Ace Editor Alignment */
        .ace_editor,
        .ace_editor * {
            font-family: 'Geist Mono', 'SF Mono', 'Monaco', 'Menlo', monospace !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
        }

        /* Ensure gutter is visible but keep original colors */
        .ace_gutter-cell {
            padding-left: 10px !important;
            padding-right: 10px !important;
            display: block !important;
            /* Restore block display for visibility */
        }

        .ace_scroller {
            line-height: 24px !important;
        }

        /* Hide fold widgets */
        .ace_fold-widget {
            display: none !important;
        }

        /* Padding for top text */
        .ace_gutter {
            padding-top: 12px !important;
        }

        .ace_scroller {
            top: 12px !important;
        }
    </style>

    <!-- Schedule Modal -->
    <dialog :open="showScheduleModal">
        <article style="max-width: 600px; width: 100%;">
            <header style="display: flex; justify-content: space-between; align-items: center; border-bottom: none;">
                <h5 style="margin: 0;">Schedule Playbook</h5>
                <button type="button" aria-label="Close" @click="showScheduleModal = false"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--ds-gray-600); line-height: 1; padding: 0;">&times;</button>
            </header>
            <section style="padding: 1rem 0;">
                <p style="color: var(--ds-gray-600); font-size: 14px; margin-bottom: 1.5rem;">
                    Run <strong>{{ name }}</strong> automatically using a Cron expression.
                </p>

                <label style="margin-bottom: 2rem;">
                    <span
                        style="display: block; font-size: 13px; font-weight: 500; color: #444; margin-bottom: 4px;">Cron
                        Expression</span>
                    <input type="text" x-model="cronExpression" placeholder="* * * * *" required
                        style="margin-bottom: 8px;">
                    <div style="color: var(--ds-gray-500); font-size: 11px;">
                        Example: <code
                            style="background: var(--ds-background-200); padding: 2px 4px; border-radius: 4px; font-size: 10px;">0 3 * * *</code>
                        (Every day at 3am)
                    </div>
                </label>

                <div style="margin-bottom: 2rem; position: relative; overflow: visible;" x-init="lucide.createIcons()">
                    <span
                        style="display: block; font-size: 13px; font-weight: 500; color: #444; margin-bottom: 4px;">Target</span>
                    <div x-data="{
                        open: false,
                        search: '',
                        getLabel() {
                            if (scheduleTargets.includes('all')) return 'All Hosts';
                            if (scheduleTargets.length === 0) return 'All Hosts';
                            if (scheduleTargets.length === 1) return scheduleTargets[0];
                            return scheduleTargets.length + ' Targets Selected';
                        },
                        isDimmed(val) {
                            return scheduleTargets.includes('all') && val !== 'all';
                        },
                        matches(text) {
                            if (!this.search) return true;
                            return text.toLowerCase().includes(this.search.toLowerCase());
                        }
                    }" @click.outside="open = false" class="geist-select-container"
                        style="position: relative; overflow: visible;">

                        <div @click.prevent="open = !open" class="geist-select-trigger" :aria-expanded="open"
                            style="user-select: none;">
                            <span x-text="getLabel()"
                                style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap; pointer-events: none;"></span>
                            <i data-lucide="chevron-down"
                                style="width: 14px; height: 14px; color: #666; pointer-events: none;"></i>
                        </div>

                        <div x-show="open" x-transition class="geist-select-dropdown" style="display: none;"
                            :style="open ? 'display: block' : 'display: none'">
                            <div style="padding: 0; border-bottom: 1px solid #EAEAEA;">
                                <input type="text" x-model="search" placeholder="Search targets..." @click.stop=""
                                    style="width: 100%; border: none !important; border-radius: 0; padding: 10px 12px; font-size: 13px; background: transparent; box-shadow: none !important; color: #000;">
                            </div>

                            <div style="max-height: 250px; overflow-y: auto; padding: 4px;">
                                <div x-show="matches('all')">
                                    <div class="geist-select-header">Global</div>
                                    <div class="geist-select-option" @click="toggleScheduleTarget('all')"
                                        :class="{ 'dimmed': isDimmed('all') }">
                                        <span class="custom-checkbox"
                                            :class="{ 'checked': scheduleTargets.includes('all') }">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                                                stroke-linecap="round" stroke-linejoin="round"
                                                x-show="scheduleTargets.includes('all')">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </span>
                                        <span>All Hosts</span>
                                    </div>
                                </div>

                                <template
                                    x-if="launchParams.availableTargets.groups && launchParams.availableTargets.groups.length > 0">
                                    <div x-show="launchParams.availableTargets.groups.some(g => matches(g))">
                                        <div class="geist-select-header">Groups</div>
                                        <template x-for="g in launchParams.availableTargets.groups" :key="g">
                                            <div class="geist-select-option" x-show="matches(g)"
                                                @click="toggleScheduleTarget(g)" :class="{ 'dimmed': isDimmed(g) }">
                                                <span class="custom-checkbox"
                                                    :class="{ 'checked': scheduleTargets.includes(g) }">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                                                        x-show="scheduleTargets.includes(g)">
                                                        <polyline points="20 6 9 17 4 12"></polyline>
                                                    </svg>
                                                </span>
                                                <span style="flex: 1;" x-text="g"></span>
                                                <span class="geist-badge">Group</span>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <template
                                    x-if="launchParams.availableTargets.hosts && launchParams.availableTargets.hosts.length > 0">
                                    <div x-show="launchParams.availableTargets.hosts.some(h => matches(h.alias))">
                                        <div class="geist-select-header">Hosts</div>
                                        <template x-for="h in launchParams.availableTargets.hosts" :key="h.alias">
                                            <div class="geist-select-option" x-show="matches(h.alias)"
                                                @click="toggleScheduleTarget(h.alias)"
                                                :class="{ 'dimmed': isDimmed(h.alias) }">
                                                <span class="custom-checkbox"
                                                    :class="{ 'checked': scheduleTargets.includes(h.alias) }">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                                                        x-show="scheduleTargets.includes(h.alias)">
                                                        <polyline points="20 6 9 17 4 12"></polyline>
                                                    </svg>
                                                </span>
                                                <span x-text="h.alias"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <footer
                    style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 1rem; border-top: none; padding: 0;">
                    <button
                        style="background-color: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 500;"
                        @click='htmx.ajax("POST", "/schedule", { values: { playbook: {{ name | tojson | forceescape }}, cron: cronExpression, target: scheduleTargets.join(",") || "all" }, swap: "none" }); showScheduleModal = false;'>
                        <i data-lucide="calendar-check" style="width: 14px; height: 14px; margin-right: 6px;"></i> Save
                        Schedule
                    </button>
                    <button class="secondary outline" @click="showScheduleModal = false"
                        style="padding: 10px 20px; border-radius: 6px;">Cancel</button>
                </footer>
            </section>
        </article>
    </dialog>

    <!-- Launchpad Modal -->
    <dialog :open="showLaunchModal">
        <article style="max-width: 600px; width: 100%;">
            <header style="display: flex; justify-content: space-between; align-items: center; border-bottom: none;">
                <h5 x-text="launchMode === 'check' ? 'Dry Run: ' + '{{ name }}' : 'Launch: ' + '{{ name }}'"
                    style="margin: 0;"></h5>
                <button type="button" aria-label="Close" @click="showLaunchModal = false"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--ds-gray-600); line-height: 1; padding: 0;">&times;</button>
            </header>

            <form
                @submit.prevent=" let vals={ limit: Array.isArray(launchParams.limit) ? launchParams.limit.join(',') : launchParams.limit, tags: launchParams.tags, verbosity: launchParams.verbosity, extra_vars: getExtraVarsJson() }; htmx.ajax('POST', (launchMode==='check' ? '/check/{{ name | safe }}' : '/run/{{ name | safe }}' ), { values: vals, target: '#terminal-container', swap: 'innerHTML' }); showLaunchModal=false; ">
                <div style="margin-bottom: 2rem; position: relative; overflow: visible;">
                    <label
                        style="display: block; font-size: 13px; font-weight: 500; color: #444; margin-bottom: 4px;">Target
                        Hosts / Groups</label>
                    <div x-data="{
                        open: false,
                        search: '',
                        getLabel() {
                            if (launchParams.limit.includes('all')) return 'All Hosts';
                            if (launchParams.limit.length === 0) return 'All Hosts';
                            if (launchParams.limit.length === 1) return launchParams.limit[0];
                            return launchParams.limit.length + ' Targets Selected';
                        },
                        isDimmed(val) {
                            return launchParams.limit.includes('all') && val !== 'all';
                        },
                        matches(text) {
                            if (!this.search) return true;
                            return text.toLowerCase().includes(this.search.toLowerCase());
                        }
                    }" @click.outside="open = false" class="geist-select-container"
                        style="position: relative; overflow: visible;">

                        <div @click.prevent="open = !open" class="geist-select-trigger" :aria-expanded="open"
                            style="user-select: none;">
                            <span x-text="getLabel()"
                                style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap; pointer-events: none;"></span>
                            <i data-lucide="chevron-down"
                                style="width: 14px; height: 14px; color: #666; pointer-events: none;"></i>
                        </div>

                        <div x-show="open" x-transition class="geist-select-dropdown" style="display: none;"
                            :style="open ? 'display: block' : 'display: none'">
                            <div style="padding: 0; border-bottom: 1px solid #EAEAEA;">
                                <input type="text" x-model="search" placeholder="Search targets..." @click.stop=""
                                    style="width: 100%; border: none !important; border-radius: 0; padding: 10px 12px; font-size: 13px; background: transparent; box-shadow: none !important; color: #000;">
                            </div>

                            <div style="max-height: 250px; overflow-y: auto; padding: 4px;">
                                <div x-show="matches('all')">
                                    <div class="geist-select-header">Global</div>
                                    <div class="geist-select-option" @click="toggleTarget('all')"
                                        :class="{ 'dimmed': isDimmed('all') }">
                                        <span class="custom-checkbox"
                                            :class="{ 'checked': launchParams.limit.includes('all') }">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                                                stroke-linecap="round" stroke-linejoin="round"
                                                x-show="launchParams.limit.includes('all')">
                                                <polyline points="20 6 9 17 4 12"></polyline>
                                            </svg>
                                        </span>
                                        <span>All Hosts</span>
                                    </div>
                                </div>

                                <template
                                    x-if="launchParams.availableTargets.groups && launchParams.availableTargets.groups.length > 0">
                                    <div x-show="launchParams.availableTargets.groups.some(g => matches(g))">
                                        <div class="geist-select-header">Groups</div>
                                        <template x-for="g in launchParams.availableTargets.groups" :key="g">
                                            <div class="geist-select-option" x-show="matches(g)"
                                                @click="toggleTarget(g)" :class="{ 'dimmed': isDimmed(g) }">
                                                <span class="custom-checkbox"
                                                    :class="{ 'checked': launchParams.limit.includes(g) }">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                                                        x-show="launchParams.limit.includes(g)">
                                                        <polyline points="20 6 9 17 4 12"></polyline>
                                                    </svg>
                                                </span>
                                                <span style="flex: 1;" x-text="g"></span>
                                                <span class="geist-badge">Group</span>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <template
                                    x-if="launchParams.availableTargets.hosts && launchParams.availableTargets.hosts.length > 0">
                                    <div x-show="launchParams.availableTargets.hosts.some(h => matches(h.alias))">
                                        <div class="geist-select-header">Hosts</div>
                                        <template x-for="h in launchParams.availableTargets.hosts" :key="h.alias">
                                            <div class="geist-select-option" x-show="matches(h.alias)"
                                                @click="toggleTarget(h.alias)" :class="{ 'dimmed': isDimmed(h.alias) }">
                                                <span class="custom-checkbox"
                                                    :class="{ 'checked': launchParams.limit.includes(h.alias) }">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                                                        x-show="launchParams.limit.includes(h.alias)">
                                                        <polyline points="20 6 9 17 4 12"></polyline>
                                                    </svg>
                                                </span>
                                                <span x-text="h.alias"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid">
                    <label>
                        Tags
                        <input type="text" x-model="launchParams.tags" placeholder="e.g. deploy, !db">
                    </label>
                    <label>
                        Verbosity
                        <select x-model="launchParams.verbosity" style="height: 42px;">
                            <option value="0">Normal</option>
                            <option value="1">Verbose (-v)</option>
                            <option value="2">More Verbose (-vv)</option>
                            <option value="3">Debug (-vvv)</option>
                        </select>
                    </label>
                </div>

                <div style="margin-top: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong style="font-size: 13px;">Extra Variables</strong>
                        <button type="button" class="outline"
                            style="padding: 2px 8px; font-size: 0.8rem; border-radius: 4px;" @click="addExtraVar()">
                            <i data-lucide="plus" style="width: 12px; height: 12px; margin-right: 4px;"></i> Add Var
                        </button>
                    </div>

                    <template x-for="(v, index) in launchParams.extraVars" :key="index">
                        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start;">
                            <input type="text" x-model="v.key" placeholder="Key"
                                style="margin-bottom: 0; min-height: 40px;">
                            <input type="text" x-model="v.value" placeholder="Value"
                                style="margin-bottom: 0; min-height: 40px;">
                            <button type="button" class="secondary outline btn-icon"
                                style="padding: 8px; border-color: #ff4444; color: #ff4444; min-height: 40px;"
                                @click="removeExtraVar(index)">
                                <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                    </template>
                </div>

                <footer style="margin-top: 2rem; padding: 0; border-top: none;">
                    <button type="submit"
                        style="background-color: #000; color: #fff; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 500; width: 100%;">
                        <i data-lucide="rocket" style="width: 14px; height: 14px; margin-right: 6px;"></i>
                        <span x-text="launchMode === 'check' ? 'Run Dry Run' : 'Launch Playbook'"></span>
                    </button>
                </footer>
            </form>
        </article>
    </dialog>
    <header class="main-header">
        <div class="header-left">
            <h4>{{ name }}</h4>
        </div>
        <div class="actions">
            <!-- Edit (Toggle) - Admin Only -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="secondary" x-show="!isEditing" @click="isEditing = true; window.startEditing()"
                title="Edit Playbook">
                <i data-lucide="edit-3" style="width: 14px; height: 14px;"></i> Edit
            </button>
            <button class="secondary" x-show="isEditing" @click="isEditing = false; window.discardEditing()"
                title="Discard Changes">
                <i data-lucide="x" style="width: 14px; height: 14px;"></i> Discard
            </button>
            {% endif %}

            <!-- Check/Run/Schedule - Admin & Operator -->
            {% if request.state.user and request.state.user.role in ['admin', 'operator'] %}
            <!-- Check (Dry Run) -->
            <button class="secondary"
                @click="launchMode = 'check'; fetchTargets(); launchParams.showTargets = false; showLaunchModal = true"
                title="Dry Run (Check Mode)">
                <i data-lucide="check-circle" style="width: 14px; height: 14px;"></i> Check
            </button>

            <!-- Run -->
            <button class="primary"
                @click="launchMode = 'run'; fetchTargets(); launchParams.showTargets = false; showLaunchModal = true">
                <i data-lucide="play" style="width: 14px; height: 14px;"></i> Run
            </button>
            {% endif %}

            <!-- Save - Admin Only -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="secondary" @click="saveFile(); isEditing = false; window.setEditorReadOnly(true)"
                title="Save Changes">
                <i data-lucide="save" style="width: 14px; height: 14px;"></i> Save
            </button>
            {% endif %}

            <!-- Schedule (Modal Trigger) - Admin & Operator -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="btn-icon" @click="showScheduleModal = true; fetchTargets()" title="Schedule">
                <i data-lucide="calendar"></i>
            </button>
            {% endif %}

            <!-- History - All -->
            <button class="btn-icon" hx-get="/history/{{ name | safe }}" hx-target="body" hx-swap="beforeend"
                title="View History">
                <i data-lucide="clock"></i>
            </button>

            <!-- Install Roles - Admin Only -->
            {% if request.state.user and request.state.user.role == 'admin' %}
            <button class="btn-icon" hx-post="/playbooks/{{ name | safe }}/install-requirements"
                hx-target="#terminal-container" hx-swap="innerHTML" title="Install Ansible Galaxy dependencies">
                <i data-lucide="download"></i>
            </button>

            <!-- Delete Button -->
            <button class="btn-icon" style="color: var(--sible-error); border-color: var(--ds-gray-200);"
                hx-delete="/playbooks/{{ name | safe }}"
                hx-confirm="Are you sure you want to delete {{ name }}? This cannot be undone."
                hx-target="#main-content" title="Delete Playbook">
                <i data-lucide="trash-2"></i>
            </button>
            {% endif %}
        </div>
    </header>

    <div class="content-area">
        <!-- Editor Pane -->
        <div class="editor-pane code-editor-wrapper" style="border: none; box-shadow: none;">
            <div id="editor"></div>
        </div>

        <!-- Terminal Pane -->
        <div class="terminal-pane">
            <div id="terminal-container" style="background-color: #ffffff; color: #000000;">
                <div class="waiting-text" style="color: #666;">Waiting for execution...</div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form for HTMX/JS to store state -->
<textarea id="hidden-content" class="d-none">{{ content }}</textarea>

<script>
    (function () {
        function initAce() {
            var editorDiv = document.getElementById("editor");
            if (!editorDiv) return;

            // Prevent double init
            if (editorDiv.classList.contains("ace_editor")) return;

            // Wait for x-show / DOM paint
            setTimeout(function () {
                var editor = ace.edit("editor");
                editor.setTheme("ace/theme/chrome");
                editor.session.setMode("ace/mode/yaml");

                // Default to Read Only
                editor.setReadOnly(true);

                // Internal state for undo
                var originalContent = "";

                // Global Helpers
                window.setEditorReadOnly = function (readonly) {
                    editor.setReadOnly(readonly);
                    if (!readonly) editor.focus();
                };

                window.startEditing = function () {
                    originalContent = editor.getValue();
                    editor.setReadOnly(false);
                    editor.focus();
                };

                window.discardEditing = function () {
                    editor.setValue(originalContent, -1);
                    editor.setReadOnly(true);
                };

                // Ensure text is visible
                editor.setShowPrintMargin(false);

                var contentArea = document.getElementById("hidden-content");
                if (contentArea) {
                    editor.setValue(contentArea.value, -1);
                }

                // Force resize
                editor.resize();

                // Save handler
                window.saveFile = function () {
                    var content = editor.getValue();
                    htmx.ajax('POST', '/playbooks/{{ name }}', {
                        values: { content: content },
                        swap: 'none'
                    }).then(() => {
                        // Update original content to the new saved state
                        originalContent = content;
                    });
                };

                // Linting Logic
                function debounce(func, wait) {
                    let timeout;
                    return function (...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                }

                function lintCode() {
                    var content = editor.getValue();
                    // Use URLSearchParams for form data
                    var formData = new URLSearchParams();
                    formData.append('content', content);

                    fetch('/lint', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(annotations => {
                            editor.getSession().setAnnotations(annotations);
                        })
                        .catch(e => console.error("Lint error", e));
                }

                var debouncedLint = debounce(lintCode, 1000);

                editor.session.on('change', function () {
                    if (!editor.getReadOnly()) {
                        debouncedLint();
                    }
                });

                // Initial lint on edit start
                var _startEditing = window.startEditing;
                window.startEditing = function () {
                    _startEditing();
                    lintCode();
                };
            }, 100);
        }

        // Run Init
        initAce();
    })();
</script>