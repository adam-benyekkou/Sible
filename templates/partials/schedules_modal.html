<header style="display: flex; justify-content: space-between; align-items: center; border-bottom: none;">
    <h5 style="margin: 0;">Edit Schedule</h5>
    <button type="button" aria-label="Close" @click="showEditModal = false"
        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--ds-gray-600); line-height: 1; padding: 0;">&times;</button>
</header>

<section style="padding: 1rem 0;">
    <p style="color: var(--ds-gray-600); font-size: 14px; margin-bottom: 1.5rem;">
        Update the cron expression and execution target for <strong>{{ job.args[0] or job.playbook }}</strong>.
    </p>

    <form hx-put="/schedule/{{ job.id }}" hx-target="#job-row-{{ job.id }}" hx-swap="outerHTML"
        hx-on:htmx:after-request="if(event.detail.successful) { $dispatch('close-modal'); }">

        <label style="margin-bottom: 2rem;">
            <span style="display: block; font-size: 13px; font-weight: 500; color: #444; margin-bottom: 4px;">Cron
                Expression</span>
            <input type="text" name="cron" value="{{ job.cron }}" placeholder="* * * * *" required
                style="margin-bottom: 8px;">
            <div style="color: var(--ds-gray-500); font-size: 11px;">
                Example: <code
                    style="background: var(--ds-background-200); padding: 2px 4px; border-radius: 4px; font-size: 10px;">0 3 * * *</code>
                (Every day at 3am)
            </div>
        </label>

        <div style="margin-bottom: 2rem; position: relative;">
            <span
                style="display: block; font-size: 13px; font-weight: 500; color: #444; margin-bottom: 4px;">Target</span>
            {% set initial_target = job.target or 'all' %}
            {% set display_label = 'all' %}
            {% if initial_target != 'all' %}
            {% set display_label = initial_target %}
            {% for g in groups %}
            {% if g == initial_target %}{% set display_label = g %}{% endif %}
            {% endfor %}
            {% for s in servers %}
            {% if s == initial_target %}{% set display_label = s ~ ' (host)' %}{% endif %}
            {% endfor %}
            {% endif %}

            <div x-data="{
                open: false,
                selected: '{{ initial_target | e }}'.split(',').filter(x => x),
                getLabel() {
                    if (this.selected.includes('all')) return 'all';
                    if (this.selected.length === 0) return 'all';
                    if (this.selected.length === 1) return this.selected[0] + (this.selected[0] === 'all' ? '' : ' (host)');
                    return this.selected.length + ' targets selected';
                },
                toggle() {
                    if (this.open) {
                        this.open = false;
                    } else {
                        this.open = true;
                    }
                },
                toggleTarget(val) {
                    if (val === 'all') {
                        this.selected = ['all'];
                    } else {
                        // Remove 'all' if selecting specific
                        this.selected = this.selected.filter(x => x !== 'all');
                        if (this.selected.includes(val)) {
                            this.selected = this.selected.filter(x => x !== val);
                        } else {
                            this.selected.push(val);
                        }
                        if (this.selected.length === 0) this.selected = ['all'];
                    }
                    // Trigger Lucide icon refresh if needed, but since we use SVG it's usually fine
                }
            }" @click.outside="open = false" @scroll.window="open = false" @resize.window="open = false"
                class="geist-select-container" style="display: block; width: 100%;">

                <input type="hidden" name="target" :value="selected.join(',')">

                <div x-ref="trigger" @click.stop="toggle()" class="geist-select-trigger" :aria-expanded="open"
                    style="display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--ds-gray-200); border-radius: 6px; padding: 0 12px; height: 36px; cursor: pointer; background: white;">
                    <span x-text="getLabel()"
                        style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;"></span>
                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #666;"></i>
                </div>

                <div x-show="open" x-transition class="geist-select-dropdown"
                    style="position: absolute; top: 100%; left: 0; width: 100%; margin-top: 4px; background: white; border: 1px solid var(--ds-gray-200); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10000; max-height: 250px; overflow-y: auto; padding: 4px;"
                    x-cloak>
                    <!-- All -->
                    <div class="geist-select-option" :class="{ 'selected': selected.includes('all') }"
                        @click="toggleTarget('all')"
                        style="padding: 8px 12px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 13px;">
                        <i data-lucide="globe" style="width: 14px; height: 14px; color: #666;"></i>
                        <span>all</span>
                        <i data-lucide="check" class="check-icon"
                            style="width: 14px; height: 14px; margin-left: auto;"></i>
                    </div>

                    <!-- Groups -->
                    {% if groups %}
                    <template x-if="true">
                        <div>
                            <div class="geist-select-header"
                                style="font-size: 11px; text-transform: uppercase; color: #888; padding: 8px 12px 4px; font-weight: 500;">
                                Groups</div>
                            {% for group in groups %}
                            <div class="geist-select-option" :class="{ 'selected': selected.includes('{{ group }}') }"
                                @click="toggleTarget('{{ group }}')"
                                style="padding: 8px 12px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                <i data-lucide="users" style="width: 14px; height: 14px; color: #666;"></i>
                                <span>{{ group }}</span>
                                <i data-lucide="check" class="check-icon"
                                    style="width: 14px; height: 14px; margin-left: auto;"></i>
                            </div>
                            {% endfor %}
                        </div>
                    </template>
                    {% endif %}

                    <!-- Servers -->
                    {% if servers %}
                    <template x-if="true">
                        <div>
                            <div class="geist-select-header"
                                style="font-size: 11px; text-transform: uppercase; color: #888; padding: 8px 12px 4px; font-weight: 500;">
                                Servers</div>
                            {% for server in servers %}
                            <div class="geist-select-option" :class="{ 'selected': selected.includes('{{ server }}') }"
                                @click="toggleTarget('{{ server }}')"
                                style="padding: 8px 12px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 13px;">
                                <i data-lucide="server" style="width: 14px; height: 14px; color: #666;"></i>
                                <span>{{ server }}</span>
                                <span style="color: #999; font-size: 11px; margin-left: 4px;">(host)</span>
                                <i data-lucide="check" class="check-icon"
                                    style="width: 14px; height: 14px; margin-left: auto;"></i>
                            </div>
                            {% endfor %}
                        </div>
                    </template>
                    {% endif %}
                </div>
            </div>
        </div>

        <footer style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 2rem; border-top: none;">
            <button type="submit" style="width: auto; background: #000; color: #fff; border: none;">Save
                Changes</button>
        </footer>
    </form>
</section>

<style>
    .geist-select-container {
        position: relative;
        width: 100%;
    }

    .geist-select-trigger {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: 36px;
        padding: 0 8px 0 12px;
        background: #ffffff;
        border: 1px solid #eaeaea;
        border-radius: 6px;
        font-size: 13px;
        color: #000;
        cursor: pointer;
        transition: all 0.15s ease;
        user-select: none;
        box-sizing: border-box;
    }

    .geist-select-trigger:hover {
        border-color: #888;
    }

    .geist-select-trigger[aria-expanded="true"] {
        border-color: #000;
    }

    .geist-select-dropdown {
        background: #ffffff;
        border: 1px solid #eaeaea;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 9999;
        max-height: 250px;
        overflow-y: auto;
        padding: 4px;
    }

    .geist-select-header {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #888;
        padding: 8px 12px 4px;
        font-weight: 500;
    }

    .geist-select-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        font-size: 13px;
        color: #000;
        cursor: pointer;
        border-radius: 4px;
    }

    .geist-select-option:hover {
        background: #fafafa;
    }

    .geist-select-option.selected {
        font-weight: 500;
        background: #fafafa;
    }

    .geist-select-option .check-icon {
        margin-left: auto;
        opacity: 0;
    }

    .geist-select-option.selected .check-icon {
        opacity: 1;
    }
</style>

<script>
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>