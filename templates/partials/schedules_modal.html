<header style="display: flex; justify-content: space-between; align-items: center; border-bottom: none;">
    <h5 style="margin: 0;">Edit Schedule</h5>
    <button type="button" aria-label="Close" @click="showEditModal = false"
        style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--ds-gray-600); line-height: 1; padding: 0;">&times;</button>
</header>

<section style="padding: 1rem 0;">
    <p style="color: var(--ds-gray-600); font-size: 14px; margin-bottom: 1.5rem;">
        Update the cron expression and execution target for <strong>{{ job.args[0] or job.playbook }}</strong>.
    </p>

    <form hx-put="/schedule/{{ job.id }}" hx-target="#job-row-{{ job.id }}" hx-swap="outerHTML"
        hx-on:htmx:after-request="if(event.detail.successful) { $dispatch('close-modal'); }">

        <label style="margin-bottom: 2rem;">
            <span style="display: block; font-size: 13px; font-weight: 500; color: #444; margin-bottom: 4px;">Cron
                Expression</span>
            <input type="text" name="cron" value="{{ job.cron }}" placeholder="* * * * *" required
                style="margin-bottom: 8px;">
            <div style="color: var(--ds-gray-500); font-size: 11px;">
                Example: <code
                    style="background: var(--ds-background-200); padding: 2px 4px; border-radius: 4px; font-size: 10px;">0 3 * * *</code>
                (Every day at 3am)
            </div>
        </label>

        <div style="margin-bottom: 2rem; position: relative;">
            <span
                style="display: block; font-size: 13px; font-weight: 500; color: #444; margin-bottom: 4px;">Target</span>
            {% set initial_target = job.target or 'all' %}

            <div x-data="{
                open: false,
                search: '',
                selected: '{{ initial_target | e }}'.split(',').filter(x => x),
                getLabel() {
                    if (this.selected.includes('all')) return 'All Hosts';
                    if (this.selected.length === 0) return 'All Hosts';
                    if (this.selected.length === 1) return this.selected[0];
                    return this.selected.length + ' Targets Selected';
                },
                toggle() {
                    this.open = !this.open;
                },
                toggleTarget(val) {
                    if (val === 'all') {
                        this.selected = ['all'];
                    } else {
                        // Remove 'all' if selecting specific
                        this.selected = this.selected.filter(x => x !== 'all');
                        if (this.selected.includes(val)) {
                            this.selected = this.selected.filter(x => x !== val);
                        } else {
                            this.selected.push(val);
                        }
                        if (this.selected.length === 0) this.selected = ['all'];
                    }
                },
                isDimmed(val) {
                    return this.selected.includes('all') && val !== 'all';
                },
                matches(text) {
                    if (!this.search) return true;
                    return text.toLowerCase().includes(this.search.toLowerCase());
                }
            }" @click.outside="open = false" class="geist-select-container">

                <input type="hidden" name="target" :value="selected.join(',')">

                <div x-ref="trigger" @click.stop="toggle()" class="geist-select-trigger" :aria-expanded="open">
                    <span x-text="getLabel()"
                        style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;"></span>
                    <i data-lucide="chevron-down" style="width: 14px; height: 14px; color: #666;"></i>
                </div>

                <div x-show="open" x-transition class="geist-select-dropdown" x-cloak>
                    <!-- Search Bar -->
                    <div style="padding: 0; border-bottom: 1px solid #EAEAEA;">
                        <input type="text" x-model="search" placeholder="Search targets..." @click.stop=""
                            style="width: 100%; border: none !important; border-radius: 0; padding: 10px 12px; font-size: 13px; background: transparent; box-shadow: none !important;">
                    </div>

                    <div style="max-height: 250px; overflow-y: auto; padding: 4px;">
                        <!-- GLOBAL -->
                        <div x-show="matches('all')">
                            <div class="geist-select-header">Global</div>
                            <div class="geist-select-option" @click="toggleTarget('all')"
                                :class="{ 'dimmed': isDimmed('all') }">
                                <span class="custom-checkbox" :class="{ 'checked': selected.includes('all') }">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                                        stroke-linecap="round" stroke-linejoin="round"
                                        x-show="selected.includes('all')">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </span>
                                <span>All Hosts</span>
                            </div>
                        </div>

                        <!-- GROUPS -->
                        {% if groups %}
                        <div x-show="{% for g in groups %}matches('{{ g }}') || {% endfor %} false">
                            <div class="geist-select-header">Groups</div>
                            {% for group in groups %}
                            <div class="geist-select-option" x-show="matches('{{ group }}')"
                                @click="toggleTarget('{{ group }}')" :class="{ 'dimmed': isDimmed('{{ group }}') }">
                                <span class="custom-checkbox" :class="{ 'checked': selected.includes('{{ group }}') }">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                                        stroke-linecap="round" stroke-linejoin="round"
                                        x-show="selected.includes('{{ group }}')">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </span>
                                <span style="flex: 1;">{{ group }}</span>
                                <span class="geist-badge">Group</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- HOSTS -->
                        {% if servers %}
                        <div x-show="{% for s in servers %}matches('{{ s }}') || {% endfor %} false">
                            <div class="geist-select-header">Hosts</div>
                            {% for server in servers %}
                            <div class="geist-select-option" x-show="matches('{{ server }}')"
                                @click="toggleTarget('{{ server }}')" :class="{ 'dimmed': isDimmed('{{ server }}') }">
                                <span class="custom-checkbox" :class="{ 'checked': selected.includes('{{ server }}') }">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                                        stroke-linecap="round" stroke-linejoin="round"
                                        x-show="selected.includes('{{ server }}')">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </span>
                                <span>{{ server }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <footer style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 2rem; border-top: none;">
            <button type="submit"
                style="width: auto; background: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 500;">Save
                Changes</button>
        </footer>
    </form>
</section>

<style>
    .geist-select-container {
        position: relative;
        width: 100%;
    }

    .geist-select-trigger {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        height: 42px;
        padding: 0 12px;
        background: #ffffff;
        border: 1px solid #EAEAEA;
        border-radius: 6px;
        font-size: 14px;
        color: #000;
        cursor: pointer;
        transition: all 0.15s ease;
        box-sizing: border-box;
    }

    .geist-select-trigger:hover {
        border-color: #000;
    }

    .geist-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        margin-top: 4px;
        background: #ffffff;
        border: 1px solid #EAEAEA;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 10000;
        overflow: hidden;
    }

    .geist-select-header {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #666666;
        padding: 12px 12px 6px;
        font-weight: 700;
    }

    .geist-select-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        font-size: 14px;
        color: #000;
        cursor: pointer;
        transition: background 0.15s;
    }

    .geist-select-option:hover {
        background: #FAFAFA;
    }

    .geist-select-option.dimmed {
        opacity: 0.4;
        pointer-events: none;
    }

    .custom-checkbox {
        width: 18px;
        height: 18px;
        border: 1px solid #EAEAEA;
        border-radius: 4px;
        background: #FFFFFF;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
    }

    .custom-checkbox.checked {
        background: #000000;
        border-color: #000000;
    }

    .custom-checkbox svg {
        width: 12px;
        height: 12px;
        color: #FFFFFF;
    }

    .geist-badge {
        background: #111111;
        color: #FFFFFF;
        font-size: 9px;
        padding: 2px 6px;
        border-radius: 4px;
        text-transform: uppercase;
        font-weight: 700;
    }
</style>

<script>
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>