<div x-data="templateEditor()" @open-template-editor.window="open($event.detail)" class="template-modal"
    :class="{ 'open': isOpen }">
    <article
        style="min-width: 800px; max-height: 90vh; overflow-y: auto; background: var(--surface-primary); border: 1px solid var(--border-subtle); border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.15);">
        <header
            style="position: relative; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-subtle); background: var(--surface-primary); padding: 1.5rem;">
            <h5 x-text="mode === 'create' ? 'New Template' : 'Edit Template'"
                style="margin: 0; color: var(--text-primary); font-weight: 600;"></h5>
            <button type="button" aria-label="Close" @click="close()"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); line-height: 1; padding: 0;">&times;</button>
        </header>

        <form @submit.prevent="save()" style="padding: 1.5rem;">
            <div class="grid">
                <label>
                    <small style="color: var(--text-muted);">Title</small>
                    <input type="text" x-model="title" required placeholder="e.g. Update System"
                        style="background: var(--surface-secondary); color: var(--text-primary); border: 1px solid var(--border-subtle);">
                </label>
                <label>
                    <small style="color: var(--text-muted);">Description</small>
                    <input type="text" x-model="description" placeholder="Short description of what this template does"
                        style="background: var(--surface-secondary); color: var(--text-primary); border: 1px solid var(--border-subtle);">
                </label>
            </div>
            <div class="grid">
                <label>
                    <small style="color: var(--text-muted);">Author</small>
                    <input type="text" x-model="author" placeholder="e.g. Sible Team"
                        style="background: var(--surface-secondary); color: var(--text-primary); border: 1px solid var(--border-subtle);">
                </label>
                <label>
                    <small style="color: var(--text-muted);">Category</small>
                    <input type="text" x-model="category" placeholder="e.g. System"
                        style="background: var(--surface-secondary); color: var(--text-primary); border: 1px solid var(--border-subtle);">
                </label>
            </div>

            <div style="margin-top: 1.5rem;">
                <label><small style="color: var(--text-muted);">Content (YAML)</small></label>
                <div class="code-editor-wrapper"
                    style="height: 400px; border: 1px solid var(--border-subtle); border-radius: 6px; overflow: hidden; margin-top: 4px;">
                    <div id="template-editor" style="height: 100%; width: 100%;"></div>
                </div>
            </div>

            <footer
                style="text-align: right; display: flex; justify-content: flex-end; margin-top: 2rem; border-top: none; padding: 0;">
                <button type="submit" aria-busy="isSaving" class="primary"
                    style="width: auto; min-width: 120px; padding: 10px 24px;">Save</button>
            </footer>
        </form>
    </article>

    <!-- Backdrop -->
    <div class="template-modal-backdrop" @click="close()"
        style="background: rgba(0, 0, 0, 0.45); backdrop-filter: blur(4px);"></div>
</div>

<style>
    .template-modal {
        display: none;
    }

    .template-modal.open {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .template-modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: -1;
    }
</style>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('templateEditor', () => ({
            isOpen: false,
            mode: 'create', // create | edit
            filename: '',
            title: '',
            description: '',
            author: '',
            category: '',
            editor: null,
            isSaving: false,

            open(detail) {
                this.mode = detail.mode;
                this.isOpen = true;
                this.isSaving = false;

                this.$nextTick(() => {
                    if (!this.editor) {
                        this.editor = ace.edit("template-editor");
                        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                        this.editor.setTheme(isDark ? "ace/theme/catppuccin_mocha" : "ace/theme/chrome");
                        this.editor.session.setMode("ace/mode/yaml");
                        this.editor.setOptions({
                            fontSize: "14px",
                            showPrintMargin: false,
                        });
                    }

                    if (this.mode === 'edit') {
                        this.filename = detail.template.id;
                        this.title = detail.template.title;
                        this.description = detail.template.description || '';
                        this.author = detail.template.author || '';
                        this.category = detail.template.category || '';
                        this.loadContent(detail.template.id);
                    } else {
                        this.filename = '';
                        this.title = 'New Template';
                        this.description = '';
                        this.author = '';
                        this.category = '';
                        this.editor.setValue("# Title: New Template\n# Description: ...\n# Author: ...\n# Category: ...\n\n- hosts: all\n  tasks:\n    - name: Hello World\n      debug:\n        msg: 'Hello'", -1);
                    }
                });
            },

            async loadContent(id) {
                try {
                    this.editor.setValue("Loading...", -1);
                    this.editor.setReadOnly(true);

                    const res = await fetch(`/api/templates/${id}/content`);
                    if (res.ok) {
                        const data = await res.json();
                        this.editor.setValue(data.content, -1);

                        // Try to extract metadata if not set (or sync it)
                        const lines = data.content.split('\n');
                        const titleLine = lines.find(l => l.startsWith('# Title:'));
                        const descLine = lines.find(l => l.startsWith('# Description:'));
                        const authorLine = lines.find(l => l.startsWith('# Author:'));
                        const categoryLine = lines.find(l => l.startsWith('# Category:'));

                        if (titleLine) this.title = titleLine.replace('# Title:', '').trim();
                        if (descLine) this.description = descLine.replace('# Description:', '').trim();
                        if (authorLine) this.author = authorLine.replace('# Author:', '').trim();
                        if (categoryLine) this.category = categoryLine.replace('# Category:', '').trim();

                    } else {
                        this.editor.setValue("# Error loading content", -1);
                    }
                } catch (e) {
                    this.editor.setValue("# Error loading content", -1);
                } finally {
                    this.editor.setReadOnly(false);
                }
            },

            close() {
                this.isOpen = false;
            },

            async save() {
                this.isSaving = true;
                let content = this.editor.getValue();

                // Auto-generate filename if creating
                if (this.mode === 'create' && !this.filename) {
                    const slug = this.title.toLowerCase()
                        .replace(/[^a-z0-9]+/g, '_')
                        .replace(/^_+|_+$/g, '');
                    this.filename = slug + '.yml';
                }

                // Inject/Update Metadata in content
                const metadata = {
                    'Title': this.title,
                    'Description': this.description,
                    'Author': this.author,
                    'Category': this.category
                };

                let lines = content.split('\n');
                let newLines = [...lines];

                for (const [key, value] of Object.entries(metadata)) {
                    if (!value) continue;

                    let found = false;
                    newLines = newLines.map(line => {
                        if (line.startsWith(`# ${key}:`)) {
                            found = true;
                            return `# ${key}: ${value}`;
                        }
                        return line;
                    });

                    if (!found) {
                        // Find where to insert - try to keep them grouped at top
                        // Ideally after other metadata or at the very top
                        // Simple approach: prepend reverse order effectively
                        newLines.unshift(`# ${key}: ${value}`);
                    }
                }
                content = newLines.join('\n');

                try {
                    const url = '/api/templates' + (this.mode === 'edit' ? `/${this.filename}` : '');
                    const method = this.mode === 'edit' ? 'PUT' : 'POST';

                    const res = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: this.filename, content: content })
                    });

                    if (res.ok) {
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Template saved', level: 'success' } }));
                        window.dispatchEvent(new CustomEvent('template-saved'));
                        this.close();
                    } else {
                        const err = await res.json();
                        window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: err.detail || 'Save failed', level: 'error' } }));
                    }
                } catch (e) {
                    console.error(e);
                    window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Network error', level: 'error' } }));
                } finally {
                    this.isSaving = false;
                }
            }
        }));
    });
</script>