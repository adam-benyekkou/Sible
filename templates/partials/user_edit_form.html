<form hx-put="/api/users/{{ user.id }}" hx-swap="none"
    hx-on::after-request="if(event.detail.successful) window.location.reload()">

    <div style="margin-bottom: 1.5rem;">
        <label
            style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Username</label>
        <input type="text" name="username" value="{{ user.username }}" required
            style="width: 100%; padding: 10px 12px; background: var(--surface-primary); color: var(--text-primary); border: 1px solid var(--border-subtle); border-radius: 6px; font-size: 14px; transition: border-color 0.15s ease, box-shadow 0.15s ease;"
            onfocus="this.style.borderColor='var(--pico-primary)'; this.style.boxShadow='0 0 0 1px var(--pico-primary)';"
            onblur="this.style.borderColor='var(--border-subtle)'; this.style.boxShadow='none';">
    </div>

    <div style="margin-bottom: 1.5rem;">
        <label
            style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">New
            Password (leave blank to keep current)</label>
        <input type="password" name="password" placeholder="Min 8 characters"
            style="width: 100%; padding: 10px 12px; background: var(--surface-primary); color: var(--text-primary); border: 1px solid var(--border-subtle); border-radius: 6px; font-size: 14px; transition: border-color 0.15s ease, box-shadow 0.15s ease;"
            onfocus="this.style.borderColor='var(--pico-primary)'; this.style.boxShadow='0 0 0 1px var(--pico-primary)';"
            onblur="this.style.borderColor='var(--border-subtle)'; this.style.boxShadow='none';">
    </div>

    <div style="margin-bottom: 2rem;">
        <label
            style="display: block; margin-bottom: 0.5rem; color: #666; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Role</label>
        <div x-data="{
            open: false,
            selected: '{{ user.role }}',
            label: '{% if user.role == 'admin' %}Admin (Full Access){% elif user.role == 'operator' %}Operator (Run Playbooks){% else %}Watcher (Read Only){% endif %}',
            top: 0,
            left: 0,
            width: 0,
            options: [
                { val: 'watcher', lbl: 'Watcher (Read Only)', icon: 'eye' },
                { val: 'operator', lbl: 'Operator (Run Playbooks)', icon: 'play' },
                { val: 'admin', lbl: 'Admin (Full Access)', icon: 'shield' }
            ],
            toggle() {
                if (this.open) {
                    this.open = false;
                } else {
                    const rect = this.$refs.trigger.getBoundingClientRect();
                    this.top = rect.bottom + 4;
                    this.left = rect.left;
                    this.width = rect.width;
                    this.open = true;
                }
            },
            select(opt) {
                this.selected = opt.val;
                this.label = opt.lbl;
                this.open = false;
            }
        }" @click.outside="open = false" @scroll.window="open = false" @resize.window="open = false"
            style="position: relative; width: 100%;">

            <input type="hidden" name="role" :value="selected">

            <div x-ref="trigger" @click.stop="toggle()"
                style="display: flex; align-items: center; justify-content: space-between; width: 100%; height: 40px; padding: 0 12px; background: var(--surface-primary); border: 1px solid var(--border-subtle); border-radius: 6px; font-size: 14px; cursor: pointer; transition: border-color 0.15s ease; color: var(--text-primary);"
                :style="open ? 'border-color: var(--pico-primary); box-shadow: 0 0 0 1px var(--pico-primary);' : ''">
                <span x-text="label"></span>
                <i data-lucide="chevron-down" style="width: 16px; height: 16px; color: var(--text-muted);"></i>
            </div>

            <div x-show="open" x-init="lucide.createIcons()"
                :style="`position: fixed; top: ${top}px; left: ${left}px; width: ${width}px; background: var(--surface-primary); border: 1px solid var(--border-subtle); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 10000; padding: 4px; color: var(--text-primary);`"
                x-cloak>
                <template x-for="opt in options" :key="opt.val">
                    <div @click="select(opt)"
                        style="padding: 10px 12px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 13px; transition: background 0.1s ease; color: var(--text-primary);"
                        :style="selected === opt.val ? 'background: var(--surface-secondary); font-weight: 500;' : ''"
                        onmouseover="this.style.background='var(--surface-secondary)'"
                        onmouseout="if(this.dataset.selected !== 'true') this.style.background='transparent'">
                        <i :data-lucide="opt.icon" style="width: 14px; height: 14px; color: var(--text-muted);"></i>
                        <span x-text="opt.lbl"></span>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <footer
        style="padding: 0; background: transparent; border: none; margin: 0; display: flex; justify-content: flex-end;">
        <button type="submit"
            style="width: auto; padding: 0 24px; background: var(--text-primary); color: var(--surface-primary); border: none; border-radius: 6px; height: 40px; font-weight: 500; cursor: pointer; transition: opacity 0.15s ease;"
            onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
            Save Changes
        </button>
    </footer>
</form>

<script>
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>