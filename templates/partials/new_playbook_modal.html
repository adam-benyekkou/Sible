<div x-data="{ 
    open: false, 
    templates: [], 
    selectedTemplate: '',
    filename: '',
    folder: '',
    error: '',
    loading: false,
    async loadTemplates() {
        try {
            const res = await fetch('/api/templates');
            if (res.ok) {
                this.templates = await res.json();
            }
        } catch(e) { console.error(e); }
    },
    async create() {
        if (!this.filename) return;
        this.loading = true;
        this.error = '';

        try {
            const res = await fetch('/api/playbooks/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: this.filename,
                    folder: this.folder,
                    template_id: this.selectedTemplate || null
                })
            });

            if (res.ok) {
                // HTMX Redirect handled by simple window location or 
                // if the response contains HX-Redirect, htmx usually handles it if driven by htmx.
                // But here we are using fetch.
                const redirect = res.headers.get('HX-Redirect');
                if (redirect) {
                    // Use HTMX to swap content if possible, or simple reload
                    htmx.ajax('GET', redirect, '#main-content');
                     // Also trigger sidebar refresh
                    document.body.dispatchEvent(new Event('sidebar-refresh'));
                    document.body.dispatchEvent(new Event('playbooks-refresh'));
                    this.open = false;
                    this.filename = '';
                    this.folder = '';
                    this.selectedTemplate = '';
                } else {
                    // Check triggers
                    const trigger = res.headers.get('HX-Trigger');
                    if (trigger) {
                        const triggers = JSON.parse(trigger);
                        if (triggers['show-toast']) {
                            window.dispatchEvent(new CustomEvent('show-toast', { detail: triggers['show-toast'] }));
                        }
                    }
                }
            } else {
                this.error = 'Failed to create playbook';
            }
        } catch(e) {
            this.error = 'Network error';
        } finally {
            this.loading = false;
        }
    }
}" @open-new-playbook-modal.window="open = true; loadTemplates();" class="modal" :class="{ 'open': open }">
    <article>

        <header
            style="position: relative; display: flex; justify-content: space-between; align-items: center; border-bottom: none;">
            <h3 style="margin: 0;">Create New Playbook</h3>
            <button type="button" aria-label="Close" @click="open = false"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--ds-gray-600); line-height: 1; padding: 0;">&times;</button>
        </header>

        <form @submit.prevent="create">
            <label>
                Folder (Optional)
                <input type="text" x-model="folder" placeholder="e.g. webservers/nginx"
                    helper="Creates parent directories if needed">
            </label>

            <label>
                Playbook Name
                <input type="text" x-model="filename" placeholder="e.g. install.yaml" required>
            </label>

            <label>
                Template (Optional)
                <select x-model="selectedTemplate"
                    @change="if(selectedTemplate && !filename) { filename = selectedTemplate.split('/').pop().replace('.yaml', '_new.yaml'); }">
                    <option value="">-- Blank Playbook --</option>
                    <template x-for="t in templates" :key="t.id">
                        <option :value="t.id" x-text="t.title + ' (' + t.category + ')'"></option>
                    </template>
                </select>
                <small x-show="selectedTemplate" x-text="templates.find(t => t.id === selectedTemplate)?.description"
                    class="color-muted"></small>
            </label>

            <div x-show="error" class="color-danger mb-2" x-text="error"></div>

            <footer
                style="text-align: right; display: flex; justify-content: flex-end; margin-top: 1rem; border-top: none;">
                <button type="submit" :aria-busy="loading" style="width: auto; min-width: 100px;">Create
                    Playbook</button>
            </footer>
        </form>
    </article>

    <!-- Modal Background -->
    <div class="modal-backdrop" @click="open = false"></div>
</div>

<style>
    .modal {
        display: none;
    }

    .modal.open {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 999;
        justify-content: center;
        align-items: center;
    }

    .modal-backdrop {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: -1;
    }
</style>