<div x-data="{ 
    selectedTargets: (typeof initialTargets !== 'undefined' ? initialTargets : 'all').split(',').filter(x => x),
    removeTarget(target) {
        this.selectedTargets = this.selectedTargets.filter(t => t !== target);
        if (this.selectedTargets.length === 0) this.selectedTargets = ['all'];
    }
}" x-init="$watch('selectedTargets', value => $dispatch('targets-changed', value))" class="target-picker-container">
    {% set picker_id = picker_id or 'picker-list' %}
    <div class="search-container">
        <input type="text" name="q" placeholder="Search targets..." hx-get="/api/inventory/targets/picker"
            hx-trigger="keyup changed delay:200ms, load" hx-target="#{{ picker_id }}" class="picker-search-input">
        <i data-lucide="search" class="search-icon"></i>
    </div>

    <div class="selected-badges" x-show="selectedTargets.length > 0">
        <template x-for="target in selectedTargets" :key="target">
            <span class="picker-badge">
                <span x-text="target === 'all' ? 'All Hosts' : target"></span>
                <button type="button" @click="removeTarget(target)">&times;</button>
            </span>
        </template>
    </div>

    <div id="{{ picker_id }}" class="picker-list-container">
        <div style="padding: 20px; text-align: center;"><span aria-busy="true">Loading targets...</span></div>
    </div>

    <input type="hidden" name="target" :value="selectedTargets.join(',')">
</div>

<style>
    .target-picker-container {
        border: 1px solid var(--border-subtle);
        border-radius: 6px;
        overflow: hidden;
        background: var(--surface-primary);
    }

    .search-container {
        position: relative;
        border-bottom: 1px solid var(--border-subtle);
    }

    .picker-search-input {
        width: 100% !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 12px 12px 12px 36px !important;
        font-size: 14px !important;
        background: transparent !important;
        box-shadow: none !important;
        margin-bottom: 0 !important;
        color: var(--text-primary) !important;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 16px;
        height: 16px;
        color: var(--text-muted);
        pointer-events: none;
    }

    .selected-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 8px 12px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-subtle);
    }

    .picker-badge {
        display: inline-flex;
        align-items: center;
        background: #000;
        color: #fff;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        gap: 6px;
    }

    [data-theme='dark'] .picker-badge {
        background: #cdd6f4;
        color: #000000;
    }

    .picker-badge button {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        padding: 0;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
        transition: color 0.1s;
    }

    [data-theme='dark'] .picker-badge button {
        color: rgba(0, 0, 0, 0.6);
    }

    .picker-badge button:hover {
        color: #fff;
    }

    [data-theme='dark'] .picker-badge button:hover {
        color: #000;
    }

    .picker-list-container {
        max-height: 240px;
        overflow-y: auto;
    }

    .picker-section {
        padding-bottom: 4px;
    }

    .picker-header {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        padding: 12px 12px 4px;
        font-weight: 600;
    }

    .picker-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.1s;
        margin-bottom: 0 !important;
        border: none !important;
    }

    .picker-row:hover {
        background: var(--bg-hover);
    }

    .picker-row.dimmed {
        opacity: 0.5;
    }

    .picker-row.disabled {
        cursor: not-allowed;
    }

    .picker-label {
        font-size: 14px;
        color: var(--text-primary);
        flex: 1;
    }

    .custom-checkbox {
        width: 18px;
        height: 18px;
        border: 1px solid var(--border-subtle);
        border-radius: 4px;
        background: var(--surface-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s;
        flex-shrink: 0;
    }

    .custom-checkbox.checked {
        background: #000000;
        border-color: #000000;
    }

    [data-theme='dark'] .custom-checkbox.checked {
        background: #cdd6f4;
        border-color: #cdd6f4;
    }

    .custom-checkbox svg {
        width: 12px;
        height: 12px;
        color: #FFFFFF;
    }

    [data-theme='dark'] .custom-checkbox svg {
        color: #000000;
    }

    .geist-badge {
        background: var(--bg-secondary);
        color: var(--text-muted);
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
    }
</style>