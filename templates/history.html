{% extends "layout.html" %}

{% block content %}
<div class="container" style="padding-top: 20px;">
    <!-- Modern Header -->
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
        <hgroup>
            <h1>History</h1>
            <h2 style="color: #666; font-size: 14px; font-weight: normal; margin-top: 4px;">Audit logs for all playbook
                executions</h2>
        </hgroup>
        {% if request.state.user.role == 'admin' %}
        <button type="button" hx-delete="/history/all"
            hx-confirm="Are you sure you want to delete ALL history logs? This cannot be undone."
            class="btn-danger-ghost"
            style="background: white; color: var(--sible-error); border: 1px solid var(--ds-gray-200); font-size: 13px; font-weight: 500; padding: 6px 16px; border-radius: 6px; cursor: pointer; transition: all 0.2s;">
            Delete All
        </button>
        {% endif %}
    </div>

    <!-- Filter Bar -->
    <div
        style="display: flex; justify-content: space-between; align-items: center; gap: 24px; margin-bottom: 24px; padding: 4px 0;">
        <div style="position: relative; flex: 1; max-width: 600px;">
            <i data-lucide="search"
                style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; color: var(--ds-gray-600); pointer-events: none;"></i>
            <input type="text" name="search" id="search-input" placeholder="Filter by playbook or folder..."
                value="{{ search or '' }}" hx-get="/history" hx-trigger="keyup changed delay:300ms, search-update"
                hx-target="#history-table-body" hx-include="[name='status']" hx-push-url="false"
                style="padding-left: 32px; height: 36px; width: 100%; font-size: 13px; margin: 0; border: 1px solid #eaeaea; border-radius: 6px; box-shadow: none !important;">
        </div>

        <div class="filter-group"
            style="display: flex; border: 1px solid #eaeaea; border-radius: 6px; overflow: hidden; width: auto; flex-shrink: 0;">
            <!-- Hidden input to store status state for hx-include -->
            <input type="hidden" name="status" id="status-input" value="{{ status or 'all' }}">

            <button type="button" class="filter-btn {{ 'active' if not status or status == 'all' else '' }}"
                onclick="updateStatus('all')"
                style="border: none; border-right: 1px solid #eaeaea; border-radius: 0; padding: 0 16px; font-size: 13px; height: 36px; min-width: 80px;">
                All
            </button>
            <button type="button" class="filter-btn {{ 'active' if status == 'success' else '' }}"
                onclick="updateStatus('success')"
                style="border: none; border-right: 1px solid #eaeaea; border-radius: 0; padding: 0 16px; font-size: 13px; height: 36px; min-width: 100px;">
                Success
            </button>
            <button type="button" class="filter-btn {{ 'active' if status == 'failed' else '' }}"
                onclick="updateStatus('failed')"
                style="border: none; border-radius: 0; padding: 0 16px; font-size: 13px; height: 36px; min-width: 100px;">
                Failed
            </button>
        </div>
    </div>

    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
            <thead>
                <tr>
                    <th
                        style="padding: 12px; border-bottom: 1px solid #eaeaea; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; color: #666; font-weight: 600;">
                        Date</th>
                    <th
                        style="padding: 12px; border-bottom: 1px solid #eaeaea; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; color: #666; font-weight: 600;">
                        Playbook</th>
                    <th
                        style="padding: 12px; border-bottom: 1px solid #eaeaea; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; color: #666; font-weight: 600;">
                        Status</th>
                    <th
                        style="padding: 12px; border-bottom: 1px solid #eaeaea; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; color: #666; font-weight: 600;">
                        Duration</th>
                    <th
                        style="padding: 12px; border-bottom: 1px solid #eaeaea; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; color: #666; font-weight: 600;">
                        Type</th>
                    <th
                        style="padding: 12px; border-bottom: 1px solid #eaeaea; text-transform: uppercase; font-size: 11px; letter-spacing: 0.05em; color: #666; font-weight: 600; text-align: right;">
                        Actions</th>
                </tr>
            </thead>
            <tbody id="history-table-body">
                {% include "partials/history_rows.html" %}
            </tbody>
        </table>
    </div>
</div>

<script>
    function updateStatus(status) {
        // Update hidden input
        document.getElementById('status-input').value = status;

        // Update visual state locally for instant feedback
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Trigger HTMX request on the search input
        const searchInput = document.getElementById('search-input');
        htmx.trigger(searchInput, 'search-update');
    }
</script>

<style>
    /* Row Hover Effect */
    tr.history-row:hover td {
        background-color: #FAFAFA !important;
    }

    /* Button Hover */
    .btn-danger-ghost:hover {
        background: var(--sible-error) !important;
        color: white !important;
        border-color: var(--sible-error) !important;
    }

    /* Filter Button Styles */
    .filter-btn {
        background: white;
        color: #666;
        cursor: pointer;
        transition: all 0.2s;
        height: 32px;
        display: flex;
        align-items: center;
    }

    .filter-btn:hover {
        background: #fafafa;
        color: #000;
    }

    .filter-btn.active {
        background: #000 !important;
        color: white !important;
    }
</style>
{% endblock %}