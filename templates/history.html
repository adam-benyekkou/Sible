{% extends "layout.html" %}

{% block content %}
<div class="container" style="padding-top: 20px;">
    <header class="flex justify-between items-center mb-4">
        <hgroup>
            <h1>History</h1>
            <h2>Audit logs for all playbook executions</h2>
        </hgroup>
        {% if request.state.user.role == 'admin' %}
        <button class="outline danger" hx-delete="/history/all"
            hx-confirm="Are you sure you want to delete ALL history logs? This cannot be undone." style="width: auto;">
            Delete All
        </button>
        {% endif %}
    </header>

    <div style="overflow-x: auto;">
        <table class="striped" style="width: 100%;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Playbook</th>
                    <th>Status</th>
                    <th>Duration</th>
                    <th>Type</th>
                    <th style="text-align: right;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for run in runs %}
                <tr id="run-row-{{ run.id }}">
                    <td>{{ run.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <a href="#" hx-get="/playbook/{{ run.playbook }}" hx-target="#main-content" hx-swap="innerHTML">
                            {{ run.playbook }}
                        </a>
                    </td>
                    <td>
                        {% if run.status == 'success' %}
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="color: green;">●</span> Success
                        </div>
                        {% elif run.status == 'failed' %}
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="color: red;">●</span> Failed
                        </div>
                        {% else %}
                        <span aria-busy="true">Running</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if run.end_time %}
                        {{ (run.end_time - run.start_time).total_seconds()|round(1) }}s
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        {{ run.trigger }}
                        {% if run.params %}
                        <div style="font-size: 0.75rem; color: #888;" title="{{ run.params }}">
                            (Custom)
                        </div>
                        {% endif %}
                    </td>
                    <td style="text-align: right;">
                        <div style="display: flex; justify-content: flex-end; gap: 10px;">
                            <button type="button" class="btn-icon" title="View Logs" hx-get="/history/run/{{ run.id }}"
                                hx-target="body" hx-swap="beforeend">
                                <i data-lucide="file-text"></i>
                            </button>
                            {% if request.state.user.role == 'admin' %}
                            <button class="btn-icon" style="color: var(--sible-error);"
                                hx-delete="/history/run/{{ run.id }}"
                                hx-confirm="Are you sure you want to delete this log permanently?"
                                hx-target="#run-row-{{ run.id }}" hx-swap="outerHTML" title="Delete">
                                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">No runs recorded yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}