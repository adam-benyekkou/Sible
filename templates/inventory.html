{% extends "layout.html" %}

{% block content %}
<div class="container-fluid" style="padding: 24px;" x-data="{ 
    isEditing: false, 
    editingId: null, 
    viewMode: 'table', // table or raw
    secrets: [],
    formData: { alias: '', hostname: '', ssh_user: 'root', ssh_port: 22, group_name: 'all', ssh_key_secret: '', ssh_password_secret: '', ssh_key_path: '' },
    init() {
        this.fetchSecrets();
        this.$watch('viewMode', () => {
            this.$nextTick(() => {
                lucide.createIcons();
            });
        });
    },
    fetchSecrets() {
        fetch('/api/inventory/secrets').then(r => r.json()).then(data => this.secrets = data);
    },
    openModal() { 
        this.isEditing = false; 
        this.resetForm();
        this.fetchSecrets();
        
        this.$nextTick(() => {
            const form = document.getElementById('inventory-form');
            if (form) {
                form.removeAttribute('hx-put');
                form.setAttribute('hx-post', '/api/inventory/hosts');
                htmx.process(form);
            }
            document.getElementById('inventory-modal').showModal(); 
        });
    },
    closeModal() { 
        document.getElementById('inventory-modal').close(); 
        this.resetForm();
    },
    editHost(id, alias, hostname, user, port, group, keyPath, keySecret, passSecret) {
        this.isEditing = true;
        this.editingId = id;
        this.formData = { 
            alias: alias, 
            hostname: hostname, 
            ssh_user: user, 
            ssh_port: port, 
            group_name: group,
            ssh_key_path: keyPath || '',
            ssh_key_secret: keySecret || '',
            ssh_password_secret: passSecret || ''
        };
        this.fetchSecrets();
        
        this.$nextTick(() => {
            const form = document.getElementById('inventory-form');
            if (form) {
                form.removeAttribute('hx-post');
                form.setAttribute('hx-put', `/api/inventory/hosts/${id}`);
                htmx.process(form);
            }
            document.getElementById('inventory-modal').showModal();
        });
    },
    resetForm() {
        this.formData = { alias: '', hostname: '', ssh_user: 'root', ssh_port: 22, group_name: 'all', ssh_key_secret: '', ssh_password_secret: '', ssh_key_path: '' };
    }
}">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h1>Inventory</h1>
            <p class="color-muted font-sm" style="margin-bottom: 0;">Manage your managed servers and groups.</p>
        </div>
        <div style="display: flex; gap: 8px;">
            <div role="group">
                <button :class="viewMode === 'table' ? 'primary' : 'secondary'"
                    @click="viewMode = 'table'">Table</button>
                <button :class="viewMode === 'raw' ? 'primary' : 'secondary'" @click="viewMode = 'raw'">Raw
                    File</button>
            </div>

            {% if request.state.user.role == 'admin' %}
            <button class="secondary" hx-post="/inventory/ping" hx-target="#ping-result" hx-swap="innerHTML"
                hx-indicator="#ping-loading" style="white-space: nowrap;">
                <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i> Ping All
            </button>

            <template x-if="viewMode === 'table'">
                <button class="primary" @click="openModal()" style="white-space: nowrap;">
                    <i data-lucide="plus" style="width: 14px; height: 14px; color: white; stroke: white;"></i> Add
                    Server
                </button>
            </template>
            {% endif %}
        </div>
    </div>

    <div id="ping-loading" class="htmx-indicator" style="margin-bottom: 1rem;">
        <span aria-busy="true">Pinging hosts...</span>
    </div>
    <div id="ping-result" style="margin-bottom: 1.5rem;"></div>

    <!-- Table View -->
    <div x-show="viewMode === 'table'">
        <div class="card" style="overflow: hidden;">
            <table class="striped" style="margin-bottom: 0;">
                <thead>
                    <tr>
                        <th>Alias</th>
                        <th>Hostname / IP</th>
                        <th>User / Port</th>
                        <th>Group</th>
                        <th>Status</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody hx-get="/api/inventory/hosts" hx-trigger="load, inventory-refresh from:body">
                    <!-- Loaded via HTMX -->
                    <tr>
                        <td colspan="6" style="padding: 24px; text-align: center; color: var(--ds-gray-600);">Loading
                            inventory...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Raw View -->
    <div x-show="viewMode === 'raw'">
        <form hx-post="/inventory/save" hx-swap="none"
            hx-on::after-request="if(event.detail.successful) htmx.ajax('POST', '/api/inventory/import', {swap:'none'})">

            <textarea name="content"
                style="font-family: 'Geist Mono', monospace; min-height: 500px; width: 100%; background: #ffffff; color: #000000; border: 1px solid var(--ds-gray-200); padding: 1rem; border-radius: 6px; resize: vertical;">{{ content }}</textarea>

            <div style="text-align: right; margin-top: 1rem;">
                <p class="font-sm color-muted" style="display: inline-block; margin-right: 1rem;">
                    Saving will overwrite the database configuration.
                </p>
                {% if request.state.user.role == 'admin' %}
                <button type="submit" class="primary" style="width: auto; height: 32px; display: inline-flex;">
                    <i data-lucide="save" style="width: 14px; height: 14px; margin-right: 6px;"></i>
                    <span>Save & Import Raw File</span>
                </button>
                {% else %}
                <button type="button" disabled>Read Only (Watcher)</button>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Include Modal -->
    {% include 'partials/inventory_modal.html' %}
</div>
{% endblock %}